/*! SccinCRM 2014-04-30 */
function logErrors(a,b,c,d){d(a)}function clientErrorHandler(a,b,c,d){b.xhr?(logger.error(a),c.send(500,{error:"服务器发生异常!"})):d(a)}function errorHandler(a,b,c){logger.error("errorHandler:",a);var d=require("util");c.status(500),c.render("error.html",{error:d.inspect(a)})}function authentication(a,b,c){return logger.debug(a.url),a.session.user||"/login"===a.url?void c():(logger.error("session验证失败！"),a.session.error="请先登陆",b.redirect("/login"))}function notAuthentication(a,b,c){return a.session.user?(a.session.error="已登陆",b.redirect("/")):void c()}function safeClient(a,b,c){var d=a.ip,e=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;if(e.test(d)){var f=appconf.allowips,g=d.split("."),h=!1;_.forEach(f,function(a){if(e.test(a)){var b=a.split(".");b[3]>0?d===a&&(h=!0):b[2]>0?g[0]===b[0]&&g[1]===b[1]&&g[2]===b[2]&&g[3]>0&&(h=!0):b[1]>0?g[0]===b[0]&&g[1]===b[1]&&g[2]>=0&&g[3]>0&&(h=!0):b[0]>0&&g[0]===b[0]&&g[1]>=0&&g[2]>=0&&g[3]>0&&(h=!0)}}),h?c():c("IP地址不被允许访问！")}else c("IP地址不合法！")}function readroutes(a,b){var c=fs.readdirSync(a),d=c.length,e=null;b&&""!==b||(b="/");for(var f=0;d>f;f++)e=c[f],setroute(a+"/"+e,b)}function setroute(a,b){fs.stat(a,function(c,d){if(c)logger.error(c);else if(d.isFile()){var e=path.basename(a,".js"),f=(path.dirname(a),path.basename(path.dirname(a))),g=path.basename(__filename,".js");e!=g&&e.indexOf(f)<0&&(app.all(b+e,function(c,d,f){var g="index",h=require(a);h&&h[c.route.method]&&"function"==typeof h[c.route.method][g]?h[c.route.method][g](c,d,f,b+e):d.render("404.html")}),app.all(b+e+"/:ooo",function(c,d,f){var g="index";c.param("ooo")&&""!==c.param("ooo")&&(g=c.param("ooo")),logger.debug(a);var h=require(a);h&&h[c.route.method]&&"function"==typeof h[c.route.method][g]?h[c.route.method][g](c,d,f,b+e):d.render("404.html")}))}else if(d.isDirectory()){var h=path.basename(a);readroutes(a,b+h+"/")}else logger.error("unknow type of file")})}var _=require("lodash"),fs=require("fs"),path=require("path"),cluster=require("cluster"),express=require("express"),partials=require("express-partials"),http=require("http"),path=require("path"),conf=require("node-conf"),nami=require(__dirname+"/asterisk/asmanager").nami,domainMiddleware=require("domain-middleware"),JugglingStore=require("connect-jugglingdb")(express),schema=require("./database/jdmysql").schema,Schemas=require(__dirname+"/modules/DBModules").Dbs,appconf=conf.load("app"),SRCFILE=appconf.debug?"src":"build",logger=require("./lib/logger").logger("web"),log4js=require("./lib/logger").log4js,server=http.createServer(),app=express();app.set("port",process.env.PORT||appconf.hostport),app.set("views",path.join(__dirname,"views")),app.set("view engine","ejs"),app.set("env",appconf.env),app.engine("html",require("ejs").renderFile),app.use(partials()),app.use(express.favicon()),app.use(log4js.connectLogger(logger,{level:log4js.levels.DEBUG,format:":method :url"})),app.use(express.bodyParser({uploadDir:"./public/uploads"})),app.use(require("stylus").middleware(path.join(__dirname,"public"))),app.use(express.static(path.join(__dirname,"public"))),app.use(domainMiddleware({server:server,killTimeout:3e4})),app.use(express.json()),app.use(express.urlencoded()),app.use(express.methodOverride()),app.use(express.cookieParser()),app.use(express.session({secret:"11366846@qq.com"})),app.use(function(a,b,c){setTimeout(function(){b.finished||(b.end(),logger.error("访问%s超时，访问方式：%s。",a.url,a.method))},6e4),c()}),"development"==app.get("env")&&(logger.info("当前运行于开发环境！"),app.use(express.errorHandler({showStack:!0,dumpExceptions:!0}))),"production"==app.get("env"),app.use(safeClient),app.use(app.router),app.get("/",function(a,b){b.redirect("/index")}),readroutes(__dirname+"/routes/"+SRCFILE+"/"),app.use(function(a,b){b.render("404.html",{status:404,title:""})}),app.use(logErrors),app.use(clientErrorHandler),app.use(errorHandler),app.locals({title:appconf.appname,phone:appconf.phone,email:appconf.email}),server.maxHeadersCount=0,server.on("request",app),server.on("error",function(a){logger.error("发生错误: ",a)}),module.parent||server.listen(app.get("port"),function(){logger.info("成功启动四川建设网语音拨打服务: "+app.get("port"))}),module.exports=server,process.on("uncaughtException",function(a){logger.error("uncaughtException:",a)});