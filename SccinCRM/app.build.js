/*! SccinCRM 2014-02-17 */
function logErrors(a,b,c,d){console.error(a.stack),d(a)}function clientErrorHandler(a,b,c,d){b.xhr?c.send(500,{error:"Something blew up!"}):d(a)}function errorHandler(a,b,c){c.status(500),c.render("error",{error:a})}var express=require("express"),routes=require("./routes/build"),user=require("./routes/build/user"),http=require("http"),path=require("path"),conf=require("node-conf"),log4js=require("log4js"),nami=require(__dirname+"/asterisk/asmanager").nami,conn=require(__dirname+"/database/mysqlconn").connection,Schemas=require(__dirname+"/database/schema").Schemas,logconf=conf.load("log4js");log4js.configure(logconf);var app=express();app.set("port",process.env.PORT||3e3),app.set("views",path.join(__dirname,"views")),app.set("view engine","ejs"),app.use(express.favicon()),app.use(express.logger("dev")),app.use(express.json()),app.use(express.urlencoded()),app.use(express.methodOverride()),app.use(express.cookieParser("your secret here")),app.use(express.session()),app.use(app.router),app.use(require("stylus").middleware(path.join(__dirname,"public"))),app.use(express.static(path.join(__dirname,"public"))),"development"==app.get("env")&&app.use(express.errorHandler()),app.use(logErrors),app.use(clientErrorHandler),app.use(errorHandler);var routings=require(__dirname+"/routes/build/routing.js");for(var i in routings)for(var r in routings[i]){var pf=require(__dirname+routings[i][r].file)[routings[i][r].fn];"get"==routings[i][r].method?app.get(routings[i][r].urlreg,pf):"post"==routings[i][r].method?app.post(routings[i][r].urlreg,pf):app.all(routings[i][r].urlreg,pf)}var count=0,server=http.createServer(app).listen(app.get("port"),function(){console.log("成功启动四川建设网语音拨打服务: "+app.get("port"))});server.maxHeadersCount=0,server.on("connection",function(){count++,console.log("当前有效连接: "+count)}),server.on("error",function(a){console.log("发生错误: ",a)});