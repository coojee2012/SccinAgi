<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sccin CallCenter Application System.">
    <meta name="author" content="linmuyi9999@163.com">
    <link rel="stylesheet" type="text/css" href="/themes/jsTree/style.min.css">
    <script type="text/javascript" src="/js/jquery-2.1.0.min.js"></script>
    <script type="text/javascript" src="/js/lib/jstree.min.js"></script>
    <script type="text/javascript">
    var ivrnum=<%= menuInst.id%>;
    var contextmenu=null;
  /*  $(document).bind("context_parse.vakata",function(e,data){
    contextmenu=$(data.element);
    alert(contextmenu.items);
  }).bind("context_show.vakata",function(e,data){
   //alert(r);
  });*/
    $(function () {
  var Tree =    $('#jstree').bind("loaded.jstree", function (e, data) {  
      }).bind('changed.jstree', function (e, data) {
        var i, j, r = [];
        for(i = 0, j = data.selected.length; i < j; i++) {
     // r.push(data.instance.get_node(data.selected[i]).text);
     var id=data.instance.get_node(data.selected[i]).id;
     var text=data.instance.get_node(data.selected[i]).text;
     var pid=data.instance.get_parent(data.selected[i]);
     var items=data.instance.settings.contextmenu.items;
    
     if(id==='actions'){
      window.parent.document.getElementById("ivraction").src="/pbx/ivracts/playback/acts?ivrnum="+ivrnum; 
      items.delete._disabled=true;
      items.addaction._disabled=false; 
      items.addinputs._disabled=true;
    }
    if(id==='inputs'){
      items.delete._disabled=true;
      items.addaction._disabled=true; 
      items.addinputs._disabled=false;
      window.parent.document.getElementById("ivraction").src="/pbx/ivracts/playback/inputs?ivrnum="+ivrnum; 
    }
    if(pid==='actions' ){
      items.delete._disabled=false;
      items.addaction._disabled=false; 
      items.addinputs._disabled=true;     
      window.parent.document.getElementById("ivraction").src="/pbx/ivracts/playback?id="+id+"&text="+text;
    }
    if(pid==='inputs'){
      items.delete._disabled=false;
      items.addaction._disabled=true; 
      items.addinputs._disabled=false; 
 //alert('inputs:'+data.instance.get_node(data.selected[i]).id)

}


}
    //$('#event_result').html('Selected: ' + r.join(', '));
  }).bind("move_node.jstree",function(e,data){
    var neworders=data.new_instance._model.data[data.parent].children.join(",");
    $.ajax({
     cache: true,
     type: "POST",
     url: '<%- baseurl%>/reorder',
                        data: {neworders:neworders},// 你的formid
                        async: false,
                        error: function (request) {
                         window.parent.$.scojs_message('连接服务器失败！', 1);
                       },
                       success: function (data) {
                        if (data.success === 'OK') {

                        }
                        window.parent.$.scojs_message(data.msg,2);
                      }
                    });
  }).bind("show_contextmenu.jstree",function(e,data){
      }).jstree({
    "core": {
      "theme": {
        "name": "small",
        "url":true,
        "dots":true
      },
      "initially_open" : [ "root" ],
      "check_callback" : function (operation, node, node_parent, node_position, more) {
            // operation can be 'create_node', 'rename_node', 'delete_node', 'move_node' or 'copy_node'
            // in case of 'rename_node' node_position is filled with the new node name
            //return operation === 'rename_node' ? true : false;
            if(operation==='move_node' && node.parent==="inputs")
              return false;
            if(operation==="delete_node" && (node.id==="actions" || node.id==="inputs"))
            {
             window.parent.$.scojs_message('此节点不能被删除！', 1);
             return false;
           }  
           else
            return true;
        },
        "notify_plugins":true,
        'data': [
        {
          'text': 'IVR<%= menuInst.id%>的执行动作',
          "icon": '/images/ivr/bell.png',
          "id":"actions",
          "type":"actionroot",
          'state': {
            'opened': true,
            'selected': false
          },
          'children':[
          <%for(var i=0;i<inst.length;i++){%>
            { 'text': '<%= inst[i].text%>',"type":"actions", "icon": '<%= inst[i].icon%>',"id":"<%= inst[i].id%>" },
            <%}%>

                                /*{ 'text': '播放语音', "icon": '/images/ivr/pi206.png',"id":"nbbb1" },
                               {'text': '拨打电话', "icon": '/images/ivr/11.png',"id":"nbbb2" },
                               {'text': '录制字符', "icon": '/images/ivr/19-2.png',"id":"nbbb3" }*/
                               ]
                             },
                             {
                              'text':'IVR<%= menuInst.id%>的按键选择',
                              'icon':'/images/ivr/19-2.png',
                              "id":"inputs",
                              "type":"inputroot",
                              'state': {
                                'opened': true,
                                'selected': false
                              },
                              'children':[
                              { 'text': '无效按键',"type":"inputs","id":"nbbb1" },
                              {'text': '输入超时',"type":"inputs", "id":"nbbb2" },
                              {'text': '重试次数',"type":"inputs", "id":"nbbb3" }
                              ]
                            }
                            ]
                          },
                          "plugins":["themes","dnd","contextmenu","ui","types"],
                          "types" : {
                            "#":{
                              "max_children":2,
                              "max_depth":-1,
                              "valid_children":["actionroot","inputroot"]
                            },
                            "default" : {
                              "icon" : "glyphicon glyphicon-flash"
                            },
                            "actionroot" : {
                              "icon" : "glyphicon glyphicon-flash",
                              "valid_children":["actions"]
                            },
                            "inputroot" : {
                              "icon" : "glyphicon glyphicon-flash",
                              "valid_children":["inputs"]

                            },
                            "actions" : {
                              "icon" : "glyphicon glyphicon-ok",
                              "valid_children":[],
                            },
                            "inputs" : {
                              "icon": '/images/ivr/19-2.png',
                              "valid_children":[]
                            }
                          },
                          "dnd":{
                           "is_draggable" : true,
                           "copy" : false
                         },
                         "contextmenu": {  
                          "select_node":true,
                          "items": {  
                             
      "addaction": {  
        "label": "添加动作",  
        "submenu": {  
          "播放语音" : {   
            "label"             : "播放语音", 
            "modeid":"1",
            "icon":"/images/ivr/19-2.png",
            "action"            :function(obj){createaction(obj);}  
          }  
        }  
      } ,  
      "addinputs": {  
        "label": "添加输入",  
        "submenu": {  
          "按键1" : {  
            "separator_before"  : false,  
            "separator_after"   : false,  
            "label"             : "按键1",  
            "action"            : function (obj) { alert("Cut") }  
          } ,"按键2" : {  
            "label"             : "按键2",  
            "action"            : function (obj) { alert("Cut") }  
          }  ,"按键3" : {  
            "label"             : "按键3",  
            "action"            : function (obj) { alert("Cut") }  
          } 
        }  
      },
       "delete": {  
                              "label": "删除",  
                              "action": function(e){delnode(e);}  
      }
    } 
  },
  "ui":{  
                     "theme_name" : "classic" //设置皮肤样式  
                   }

                 });
});


function createaction(obj,cb){
  var menmu=obj.item;
  var ref=$('#jstree').jstree(true);
  var sel = ref.get_selected(true);
  var pos="last";
  if(sel.length>0 ){
    if(sel[0].id!=='actions')
      sel=sel[0].parent;
    else
      sel=sel[0];
  }else{
    window.parent.$.scojs_message('树异常！', 1);
    return false;
  }
  var modeid=menmu.modeid;
  $.ajax({
    cache: true,
    type: "POST",
    url: '<%- baseurl%>/addaction',
                        data: {ivrnum:ivrnum,modeid:modeid},// 你的formid
                        async: false,
                        error: function (request) {
                         window.parent.$.scojs_message('连接服务器失败！', 1);
                       },
                       success: function (data) {
                        if (data.success === 'OK') {
                          var node={"id":data.id,"text":menmu.label,"type":"actions","icon":menmu.icon};
                          sel= ref.create_node(sel,node);
                          if(sel){
                            window.parent.$.scojs_message("新增动作成功!",2);
                          }else{
                            window.parent.$.scojs_message("新增插入显示失败!",2);
                          }
                        }else{
                          window.parent.$.scojs_message("新增失败:"+data.msg,1);
                        }
                        
                      }
                    });
}
function delnode(e){
  var ref=$('#jstree').jstree(true);
  var sel = ref.get_selected(true);
  var ids=[];
  var delstype="delaction";
   if(sel.length>0 ){
    for(var i=0;i<sel.length;i++){
        if(sel[i].id==='actions' || sel[i].id ==="inputs")
     {
       continue;
     }
    else
    {
      ids.push(sel[i].id);
      if(sel[i].type==="inputs")
        delstype="delinput";
    }
  }
  
  }else{
    window.parent.$.scojs_message('没有选择要删除的！', 1);
    return false;
  }
 
  $.ajax({
    cache: true,
    type: "POST",
    url: '<%- baseurl%>/'+delstype,
                        data: {ids:ids.join(","),ivrnum:ivrnum},// 你的formid
                        async: false,
                        error: function (request) {
                         window.parent.$.scojs_message('连接服务器失败！', 1);
                       },
                       success: function (data) {
                        if (data.success === 'OK') {
                          var delstatus= ref.delete_node(sel);
                          if(delstatus){
                            window.parent.$.scojs_message("删除成功!",2);
                          }else{
                            window.parent.$.scojs_message("删除显示失败!",2);
                          }
                        }else{
                          window.parent.$.scojs_message("删除失败:"+data.msg,1);
                        }
                        
                      }
        });

  
}

</script>
</head>
<body>
<div id="jstree">
</div>
</body>
</html>