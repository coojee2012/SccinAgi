/*! 路由处理程序 2014-04-11 */
function parkCalls(a){var b=new AsAction.ParkedCalls;nami.send(b,function(b){a(b)})}function getconnectchannel(a,b,c){var d="",e="",f="^"+a+"\\/"+b,g=new RegExp(f,"gi");console.log(g);var h=new AsAction.CoreShowChannels;nami.send(h,function(a){if("Success"==a.response)for(var f in a.events)if(g.exec(a.events[f].channel)||a.events[f].accountcode==b){d=a.events[f].channel,e=a.events[f].bridgedchannel;break}c({src:d,dst:e})})}function safekey(){require("crypto"),require("fs")}var conf=require("node-conf"),basedir=conf.load("app").appbase,tts=require(basedir+"/lib/tts").tts,nami=require(basedir+"/asterisk/asmanager").nami,util=require("util"),async=require("async"),AsAction=require("nami").Actions,Schemas=require(basedir+"/database/schema").Schemas,guid=require("guid"),logger=require(basedir+"/lib/logger").logger("web"),gets={},posts={};module.exports={get:gets,post:posts},posts.sippeers=function(a,b){nami.send(new AsAction.SipPeers,function(a){console.log(a),b.send(a)})},posts.ping=function(a,b){nami.send(new AsAction.Ping,function(a){console.log(a),b.send(a)})},posts.hangup=function(a,b){var c=new AsAction.Hangup;c.Channel="sip/abcd",nami.send(c,function(a){console.log(a),b.send(a)})},posts.status=function(a,b){var c=new AsAction.Status;nami.send(c,function(a){console.log(a),b.send(a)})},posts.command=function(a,b){var c=a.body.cmd||a.query.cmd,d=new AsAction.Command;d.Command=c,nami.send(d,function(a){console.log(a),b.send(a)})},posts.extensionstate=function(a,b){var c=a.body.exten||a.query.exten,d=a.body.context||a.query.context,e=new AsAction.ExtensionState;e.Exten=c,e.Context=d,nami.send(e,function(a){console.log(a),b.send(a)})},posts.getconfig=function(a,b){var c=a.body.filename||a.query.filename,d=a.body.category||a.query.category,e=new AsAction.GetConfig;e.Filename=c,e.Category=d,nami.send(e,function(a){console.log(a),b.send(a)})},posts.createconfig=function(a,b){var c=a.body.filename||a.query.filename,d=new AsAction.CreateConfig;d.Filename=c,nami.send(d,function(a){console.log(a),b.send(a)})},posts.getconfigjson=function(a,b){var c=a.body.filename||a.query.filename,d=new AsAction.GetConfigJson;d.Filename=c,nami.send(d,function(a){console.log(a),b.send(a)})},posts.DAHDIShowChannels=function(a,b){var c=new AsAction.DahdiShowChannels;nami.send(c,function(a){console.log(a),b.send(a)})},posts.coreshowchannels=function(a,b){var c=new AsAction.CoreShowChannels;nami.send(c,function(a){console.log(a),b.send(a)})},posts.hangupexten=function(a,b){var c=a.body.exten||a.query.exten,d=a.body.type||a.query.type;d||(d="SIP"),getconnectchannel(d,c,function(a){console.log(a);var c=new AsAction.Hangup;c.Channel=a.src,nami.send(c,function(a){b.send(a)})})},posts.transfer=function(a,b){var c=a.body.extenfrom||a.query.extenfrom,d=a.body.extento||a.query.extento,e=a.body.fromtype||a.query.fromtype;e||(e="SIP"),getconnectchannel(e,c,function(a){var c=new AsAction.Redirect;c.Channel=a.src,c.Exten=d,c.Context="from-exten-sip",nami.send(c,function(a){b.send(a)})})},posts.dialout=function(a,b){var c=(a.body.variable||a.query.variable,a.body.outnumber||a.query.outnumber),d=a.body.exten||a.query.exten,e="LOCAL/"+c+"@sub-outgoing",f="sub-outgoing-callback",g=new AsAction.Originate;g.Channel=e,g.Async=!0,g.Account=d,g.CallerID=d,g.Context=f,g.Exten=d,console.log(g),nami.connected?nami.send(g,function(a){b.send(a)}):b.send({Response:"NotConnected"})},posts.autodial=function(a,b){var c=a.get("User-key"),d=a.get("User-Agent");logger.debug("拨打服务获取到的头信息：",c,d),b.setHeader("Content-type","application/json");var e=a.body.CallInfoID,f=a.body.ProjMoveID,g=a.body.NoticeContent;g=g.replace(/\s+/g,"");var h=a.body.SureContent;h=h.replace(/\s+/g,"");var i=a.body.QueryContent;i=i.replace(/\s+/g,"");var j=a.body.Phones;j=j.replace(/\s+/g,"");var k=a.body.KeyNum;e&&""!=e?f&&""!=f?g&&""!=g?h&&""!=h?i&&""!=i?j&&""!=j?async.auto({addCallRecords:function(a){try{Schemas.crmCallRecords.create({id:guid.create(),CallInfoID:e,ProjMoveID:f},function(b,c){a(b,c)})}catch(b){a(b,null)}},getSythState:function(a){try{Schemas.crmVoiceContent.find(f,function(b,c){a(b,c)})}catch(b){a(b,null)}},addVoiceContent:["addCallRecords","getSythState",function(a,b){try{null===b.getSythState?Schemas.crmVoiceContent.create({NoticeContents:g,SureContents:h,QueryContents:i,id:f},function(b,c){a(b,c)}):a(null,b.getSythState)}catch(c){a(c,null)}}],addCallPhone:["addCallRecords",function(a,b){var c=j.split(","),d=0;async.whilst(function(){return d<c.length},function(a){d++,Schemas.crmCallPhone.create({id:guid.create(),Phone:c[d-1],PhoneSequ:d-1,callrecord:b.addCallRecords},function(b,c){a(b,c)})},function(b,c){a(b,c)})}],addDialResult:["addCallRecords",function(a,b){Schemas.crmDialResult.create({CallInfoID:e,callrecord:b.addCallRecords},function(b,c){a(b,c)})}],setVoiceContent:["addVoiceContent",function(a,b){try{if(0===b.addVoiceContent.State){var c=new Schemas.crmVoiceContent(b.addVoiceContent);c.State=1,c.save(function(b,c){a(b,c)})}else 1===b.addVoiceContent.State?a("有相同项目编号的语音正在合成中！",null):a(null,b.addVoiceContent)}catch(d){a("更新合成中状态时发生错误！",null)}}],voiceMixNotice:["setVoiceContent",function(a,b){1===b.setVoiceContent.State?tts.synth("/home/share/"+f+"-notice.wav",g,function(b,c){"true"===b?a(null,null):(logger.error("合成通知语音失败:",c),a("合成通知语音失败！",null))}):a(null,null)}],voiceMixSure:["voiceMixNotice",function(a,b){1===b.setVoiceContent.State?tts.synth("/home/share/"+f+"-sure.wav",h,function(b,c){"true"===b?a(null,null):(logger.error("合成确认语音失败:",c),a("合成确认语音失败!",null))}):a(null,null)}],voiceMixQuery:["voiceMixSure",function(a,b){1===b.setVoiceContent.State?tts.synth("/home/share/"+f+"-query.wav",i,function(b,c){"true"===b?a(null,null):(logger.error("合成查询语音失败:",c),a("合成查询语音失败!",null))}):a(null,null)}],updateVoiceContent:["voiceMixNotice","voiceMixSure","voiceMixQuery","addVoiceContent",function(a,b){try{var c=new Schemas.crmVoiceContent(b.addVoiceContent);c.State=2,c.save(function(b,c){a(b,c)})}catch(d){a("更新合成完成状态时发生错误！",null)}}],checkChans:["updateVoiceContent",function(a){Schemas.pbxCdr.count({alive:"yes"},function(b,c){b?a(b,null):c&&c>60?a("当前可用线路不足，已用:"+c,c):a(null,c)})}],callDial:["checkChans",function(a,b){var c="LOCAL/200@sub-outgoing",d="sub-outgoing-callback",e=new AsAction.Originate;e.Channel=c,e.Async=!0,e.Account=b.addCallRecords.id,e.CallerID=200,e.Context=d,e.Variable="callrecordid="+b.addCallRecords.id+",keynum="+k,e.Exten=200,nami.connected?nami.send(e,function(b){a(null,b)}):a("无法连接到语音服务器！",null)}]},function(a){if(a){logger.error("调用拨打服务发生异常：",a);var c="";"object"==typeof a?c+=a.TypeError||a.Error||"":c=a,b.send({success:!1,result:"服务器发生内部异常:"+c+",请联系系统管理员！"})}else b.send({success:!0,result:"调用成功！"})}):b.send({success:!1,result:"拨打电话不能为空"}):b.send({success:!1,result:"合成自动查询语音类容不能为空"}):b.send({success:!1,result:"合成确认参加评标提示语音类容不能为空"}):b.send({success:!1,result:"合成通知评标专家语音类容不能为空"}):b.send({success:!1,result:"项目编号不能为空"}):b.send({success:!1,result:"抽取编号不能为空"})},posts.getresult=function(a,b){var c=a.get("User-key"),d=a.get("User-Agent");logger.debug("获取结果服务获取到的头信息：",c,d),b.setHeader("Content-type","application/json"),b.setHeader("Access-Control-Allow-Origin",a.headers.origin);var e=a.body.CallInfoID;if(logger.debug("开始获取："+e+"的呼叫结果！"),e&&""!=e)try{Schemas.crmDialResult.findOne({where:{CallInfoID:e}},function(a,c){b.send(a?{success:!1,result:"获取拨打结果时服务器发生异常"}:null==c?{success:!1,result:"在服务器上没有找到该数据"}:{success:!0,result:c.Result.toString()})})}catch(f){logger.error("获取拨打结果发生异常：",f),b.send({success:!1,result:"获取拨打结果时服务器发生异常"})}else b.send({success:!1,result:"抽取编号不能为空"})},posts.packCall=function(a,b){var c=a.body.exten||a.query.exten,d=a.body.type||a.query.type;d||(d="SIP");a.body.timeout||a.query.timeout;getconnectchannel(d,c,function(a){console.log(a);var c=new AsAction.Park;c.Channel2=a.src,c.Channel=a.dst,c.Timeout=12e4,nami.send(c,function(a){b.send(a)})})},posts.unPark=function(a,b){var c=a.body.exten||a.query.exten,d=a.body.type||a.query.type;d||(d="SIP"),parkCalls(function(a){if("Success"===a.Response||"Success"===a.response)if(null!=a.events&&a.events.length>0)for(var e=0;e<a.events.length;e++){var f=a.events[e].from,g=new RegExp(d+"/"+c,"g");if(f.match(g)){var h=a.events[e].channel,i=new AsAction.Redirect;i.Channel=h,i.Exten=c,i.Context="app-exten",nami.send(i,function(a){b.send(a)});break}}else b.send({response:"Error",Msg:"当前没有被保持的通话！"});else b.send(a)})},posts.checkService=function(a,b){var c=a.body.exten||a.query.exten,d=a.body.type||a.query.type;d||(d="SIP"),getconnectchannel(d,c,function(a){var d=new AsAction.Redirect;d.Channel=a.src,d.Exten=c,d.Context="checkservice",nami.send(d,function(a){b.send(a)})})},posts.GetCallInfo=function(a,b){var c=a.body.fromexten||a.query.fromexten;if(null==c||""==c)b.send({success:"0"});else{var d=require("../modules/ippbx/callevent.js");d.findOne({where:{extensionnumber:c}},function(a,c){if(a||null==c)b.send({success:"0"});else{var e={};"waite"==c.status?(e.success=1,"2"==c.routerdype?(e.caller=c.callednumber,e.called=c.callernumber):(e.caller=c.callernumber,e.called=c.callednumber),e.unid=c.uid,e.poptype=c.poptype,e.callid=c.callid,c.status="over",c.poptype="",d.updateOrCreate(c,function(a){b.send(a?{success:"0"}:e)})):b.send({success:"0"})}})}},posts.DadOn=function(a,b){var c=a.body.exten||a.query.exten,d=(a.body.type||a.query.type,require("../modules/ippbx/extension.js"));try{d.all({where:{accountcode:c}},function(a,e){if(a)return void b.send({Response:"Error",Msg:"获取分机号失败!"});if(console.log(e),null!=e){var f=e[0];f.dndinfo="on"===f.dndinfo?"off":"on",d.updateOrCreate(f,function(a){b.send(a?{Response:"Error",Msg:"更新状态失败!"}:{Response:"Success",Msg:"操作成功!"})})}else b.send({Response:"Error",Msg:"没有找到分机号,"+c})})}catch(e){b.send({Response:"Error",Msg:e})}};