/*! 路由处理程序 2014-04-02 */
var conf=require("node-conf"),basedir=conf.load("app").appbase,Schemas=require(basedir+"/database/schema").Schemas,async=require("async"),logger=require(basedir+"/lib/logger").logger("web"),gets={},posts={};module.exports={get:gets,post:posts},posts.pagination=function(a,b){logger.debug("BODY:",a.body);var c=a.body.dbName,d=a.body.iDisplayStart,e=a.body.iDisplayLength;-1==e&&(e=1e4);for(var f=(parseInt(a.body.iColumns),a.body.sColumns.split(",")),g=a.body.iSortingCols,h="",i=0;g>i;i++){var j=a.body["iSortCol_"+i],k=a.body["bSortable_"+j];if("true"==k&&""!=h){var l=a.body["sSortDir_"+i];h+=","+f[j]+" "+("asc"===l?"asc":"desc")}else if("true"==k&&""==h){var l=a.body["sSortDir_"+i];h+=f[j]+" "+("asc"===l?"asc":"desc")}}(null==h||""==h)&&(h="id DESC"),logger.info("排序条件:",h);var m={};m.id={neq:""};for(var n=parseInt(a.body.whereCount),i=0;n>i;i++){var o=a.body["whereCol_"+i],p=a.body["whereWay_"+i],q=a.body["whereValue_"+i];q&&""!=q&&-1!=q&&(m[o]={},p&&""!=p?m[o][p]=q:m[o]=q)}logger.info("查询条件:",m);var r=new Array;for(var s in Schemas[c].relations)r.push(s);logger.info("具有的关系:",r),async.auto({count:function(a){Schemas[c].count(m,function(b,c){a(b,c)})},search:function(a){logger.info("查询的数据库名称：",c),Schemas[c].all({include:r,where:m,order:h,skip:d,limit:e},function(b,c){a(b,c)})}},function(c,d){if(c)logger.error(c),b.send({error:c});else{var e={};e.iTotalRecords=d.count,e.iTotalDisplayRecords=d.count,e.sEcho=a.body.sEcho,e.aaData=[];for(var g=0;g<d.search.length;g++){for(var h={},i=0;i<f.length;i++)h[f[i]]=d.search[g].__cachedRelations[f[i]]&&null!==d.search[g].__cachedRelations[f[i]]?d.search[g].__cachedRelations[f[i]]:d.search[g][f[i]];e.aaData[g]=h}logger.info("获取到列表数据：",e),b.send(e)}})};