/*! 路由处理程序 2014-09-03 */
function setTrunkDev(a,b){var c="";"SIP"===a.trunkproto||"IAX2"===a.trunkproto?(c=getRandomStr(10),b(null,c)):"PRI"===a.trunkproto||"FXO"===a.trunkproto?Schemas.pbxTrunk.all({where:{trunkproto:{inq:["PRI","FXO"]}}},function(a,c){var d=0;if(null!==c){var e=_.range(c.length+1),f=_.map(c,function(a){return _.parseInt(a.trunkdevice)});d=_.chain(e).difference(f).min()}b(a,d)}):b(null,a.trunkdevice)}function getRandomStr(a){for(var b="123456789poiuytrewqasdfghjklmnbvcxzQWERTYUIPLKJHGFDSAZXCVBNM",c="",d=0;a>d;d++)c+=b.charAt(Math.ceil(1e8*Math.random())%b.length);return c}function getHasChannels(a,b){var c="";Schemas.pbxCard.all({where:{trunkproto:a,dataline:{neq:"是"},group:"-1"},order:["cardname asc","line asc"]},function(d,e){if(d)b(d,null);else{for(var f=0;f<e.length;f++)c+='<option value="'+e[f].line+'">['+e[f].cardname+"]"+a+" - "+e[f].line+" </option>";b(null,c)}})}function getyyChannels(a,b){var c="";if(!a||""==a)return void b(null,"");var d="",e=a.split("&");if(e.forEach(function(a){var b=a.split("=");"channel"===b[0]&&(d=b[1])}),!d||""===d)return void b(null,"");var f=d.split(",");f=_.map(f,function(a){return _.parseInt(a)}),Schemas.pbxCard.all({where:{line:{inq:f}},order:["cardname asc","line asc"]},function(a,d){a?b(a,null):(_.forEach(d,function(a){c+='<option value="'+a.line+'">['+a.cardname+"]"+a.trunkproto+" - "+a.line+" </option>"}),b(null,c))})}function updateChannels(a,b,c){async.each(a,function(a,c){Schemas.pbxCard.update({where:{line:a},update:{group:b}},function(a,b){c(a,b)})},function(a,b){c(a,b)})}var guid=require("guid"),async=require("async"),_=require("lodash"),conf=require("node-conf"),basedir=conf.load("app").appbase,Schemas=require(basedir+"/database/schema").Schemas,logger=require(basedir+"/lib/logger").logger("web"),gets={},posts={};module.exports={get:gets,post:posts};var checkFun={};posts.checkAjax=function(a,b){var c=a.body.param,d=a.body.name;checkFun[d](c,b)},gets.index=function(a,b,c,d){b.render("."+d+"/list.html",{baseurl:d,modename:"pbxTrunk"})},gets.create=function(a,b,c,d){var e=a.query.trunkproto;e&&""!=e||(e="SIP"),async.auto({getHasChannels:function(a){getHasChannels(e,function(b,c){a(b,c)})}},function(a,c){a?logger.error(a):b.render("."+d+"/create.html",{baseurl:d,trunkproto:e,hasChannels:c.getHasChannels,yyChannels:"",partv:"part"+e+".html"})})},gets.edit=function(a,b,c,d){var e=a.query.id;async.auto({findTrunk:function(a){Schemas.pbxTrunk.find(e,function(b,c){b||null==c?a("编辑查找发生错误或数据不存在！",c):a(b,c)})},getHasChannels:["findTrunk",function(a,b){_.contains(["FXO","PRI"],b.findTrunk.trunkproto)?getHasChannels(b.findTrunk.trunkproto,function(b,c){a(null,c)}):a(null,"")}],getyyChannels:["findTrunk",function(a,b){_.contains(["FXO","PRI"],b.findTrunk.trunkproto)?getyyChannels(b.findTrunk.args,function(b,c){a(null,c)}):a(null,"")}]},function(a,c){b.render("."+d+"/edit.html",{baseurl:d,hasChannels:c.getHasChannels,yyChannels:c.getyyChannels,partv:"part"+c.findTrunk.trunkproto+".html",inst:c.findTrunk})})},posts.save=function(a,b){var c={};c.args="";for(var d in a.body)/^str\_(\S+)/.test(d)?c.args+=RegExp.$1+"="+a.body[d]+"&":c[d]=a.body[d];""!==c.args&&(c.args=c.args.toString().substring(0,c.args.length-1)),async.auto({isHaveCheck:function(a){Schemas.pbxTrunk.find(c.id,function(b,c){a(b,c)})},createNew:["isHaveCheck",function(a,b){null!==b.isHaveCheck?a(null,-1):(c.id=guid.create(),setTrunkDev(c,function(b,d){b?a(b,-1):(c.trunkdevice=d,Schemas.pbxTrunk.create(c,function(b,c){if(b)a(b,-1);else if("PRI"===c.trunkproto||"FXO"===c.trunkproto){var e=c.args.split("="),f=[];e[1]&&""!==e[1]&&(f=e[1].split(",")),updateChannels(f,d,function(b){a(b,c)})}else a(b,c)}))}))}],updateOld:["isHaveCheck",function(a,b){null===b.isHaveCheck?a(null,-1):Schemas.pbxTrunk.update({where:{id:c.id},update:c},function(d,e){if("PRI"===b.isHaveCheck.trunkproto||"FXO"===b.isHaveCheck.trunkproto){var f=b.isHaveCheck.args,g=f.split("="),h=[];g[1]&&""!==g[1]&&(h=g[1].split(","));var i=c.args.split("="),j=[];i[1]&&""!==i[1]&&(j=i[1].split(",")),updateChannels(h,"-1",function(){updateChannels(j,b.isHaveCheck.trunkdevice,function(b){a(b,e)})})}else a(d,e)})}]},function(a,c){var d={success:"",id:"",msg:""};-1!==c.createNew?c.createNew.isValid(function(a){a?(d.success="OK",d.msg="新增成功,请及时同步到服务器，使其生效！",d.id=c.createNew.id):(d.success="ERROR",d.msg="服务器感知到你提交的数据非法，不予受理！")}):-1!==c.updateOld?(d.success="OK",d.msg="修改成功,请及时同步到服务器，使其生效！",d.id=c.updateOld.id):a&&(console.log(a),d.success="ERROR",d.msg="保存数据发生异常,请联系管理员！"),b.send(d)})},posts.delete=function(a,b){var c=a.body.id;Schemas.pbxTrunk.find(c,function(a,c){var d={};a?(d.success="ERROR",d.msg="查询数据发生异常,请联系管理员！"):c?async.auto({updateDahdi:function(a){if(_.contains(["FXO","PRI"],c.trunkproto)){var b=c.args,d=b.split("="),e=[];d[1]&&""!==d[1]&&(e=d[1].split(",")),updateChannels(e,"-1",function(b,c){a(b,c)})}else a(null,1)},destory:function(a){c.destroy(function(b){a(b,1)})}},function(a){a?(d.success="ERROR",d.msg="删除数据发生异常,请联系管理员！！"):(d.success="OK",d.msg="删除成功,请及时同步到服务器，使其生效！"),b.send(d)}):(d.success="ERROR",d.msg="没有找到需要删除的数据！",b.send(d))})};