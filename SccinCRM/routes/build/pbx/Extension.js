/*! 路由处理程序 2015-05-13 */
var conf=require("node-conf"),basedir=conf.load("app").appbase,Schemas=require(basedir+"/database/schema").Schemas,async=require("async"),logger=require(basedir+"/lib/logger").logger("web"),commfun=require(basedir+"/lib/comfun"),util=require("util"),gets={},posts={};module.exports={get:gets,post:posts};var checkFun={};checkFun.accountcode=function(a,b){a&&""!=a?Schemas.pbxExtension.find(a,function(a,c){b.send(a?{info:"后台验证发生错误！",status:"n"}:null!=c?{info:"分机已经存在！",status:"n"}:{info:"验证通过！",status:"y"})}):b.send({info:"输入的分机号不能为空！",status:"n"})},gets.index=function(a,b,c,d){b.render("pbx/Extension/list.html",{pageIndex:a.query.displayStart||0,where:util.inspect(commfun.searchContions(a.query.where)),baseurl:d})},gets.upsert=function(a,b,c,d){b.render("pbx/Extension/upsert.html",{baseurl:d})},gets.create=function(a,b,c,d){var e=a.query.deviceproto;e&&""!=e||(e="SIP"),b.render("pbx/Extension/create.html",{baseurl:d,deviceproto:e,partv:"partv"+e+".html"})},gets.edit=function(a,b,c,d){var e=a.query.id;Schemas.pbxExtension.find(e,function(c,e){c?b.redirect(500,"/err/500"):null!=e?b.render("pbx/Extension/edit.html",{baseurl:d,inst:e,displayStart:a.query.displayStart||0,where:a.query.where||"",partv:"partv"+e.deviceproto+".html"}):b.redirect(404,"/err/404")})},posts["delete"]=function(a,b,c,d){var e=a.body.id;Schemas.pbxExtension.find(e,function(a,c){var d={};a?(d.success="ERROR",d.msg="查询数据发生异常,请联系管理员！",b.send(d)):c?c.destroy(function(a){a?(d.success="ERROR",d.msg="删除数据发生异常,请联系管理员！！",b.send(d)):commfun.dellocalnum(e,function(a,c){a?(d.success="ERROR",d.msg="删除分机本地号码发生异常,请联系管理员！！",b.send(d)):(d.success="OK",d.msg="删除成功！",b.send(d))})}):(d.success="ERROR",d.msg="没有找到需要删除的数据！",b.send(d))})},posts.save=function(a,b,c,d){var e={};e.devicestring="";for(var f in a.body)if(/^str\_(\S+)/.test(f)){var g=RegExp.$1;console.log(g),e.devicestring+=g+"="+a.body[f]+"&"}else e[f]=a.body[f];e.devicestring+="secret="+a.body.password+"&",e.devicestring=e.devicestring.toString().substring(0,e.devicestring.length-1),e.devicenumber=e.accountcode,async.auto({isHaveCheck:function(a){Schemas.pbxExtension.find(e.id,function(b,c){a(b,c)})},createNew:["isHaveCheck",function(a,b){null!==b.isHaveCheck?a(null,-1):(e.id=e.accountcode,Schemas.pbxExtension.create(e,function(b,c){a(b,c)}))}],updateOld:["isHaveCheck",function(a,b){null===b.isHaveCheck?a(null,-1):Schemas.pbxExtension.update({where:{id:e.id},update:e},function(b,c){a(b,c)})}],addlocalnum:["createNew",function(a,b){commfun.addlocalnum(b.createNew.id,"extension","",a)}]},function(a,c){var d={success:"",id:"",msg:""};-1!==c.createNew?c.createNew.isValid(function(a){a?(d.success="OK",d.msg="新增成功!",d.id=c.createNew.id):(d.success="ERROR",d.msg="服务器感知到你提交的数据非法，不予受理！")}):-1!==c.updateOld?(d.success="OK",d.msg="修改成功!",d.id=c.updateOld.id):a&&(console.log(a),d.success="ERROR",d.msg="保存数据发生异常,请联系管理员！"),b.send(d)})},posts.checkAjax=function(a,b,c,d){var e=a.body.param,f=a.body.name;checkFun[f](e,b)},posts.table=function(a,b,c,d){console.log("BODY:",a.body);var e=a.body.dbName,f=a.body.iDisplayStart,g=a.body.iDisplayLength;-1==g&&(g=1e4);for(var h=(parseInt(a.body.iColumns),a.body.sColumns.split(",")),i=a.body.iSortingCols,j="",k=0;i>k;k++){var l=a.body["iSortCol_"+k],m=a.body["bSortable_"+l];if("true"==m&&""!=j){var n=a.body["sSortDir_"+k];j+=","+h[l]+" "+("asc"===n?"asc":"desc")}else if("true"==m&&""==j){var n=a.body["sSortDir_"+k];j+=h[l]+" "+("asc"===n?"asc":"desc")}}(null==j||""==j)&&(j="id DESC"),console.log("排序条件:",j);var o={};o.id={neq:""};for(var p=parseInt(a.body.whereCount),k=0;p>k;k++){var q=a.body["whereCol_"+k],r=a.body["whereWay_"+k],s=a.body["whereValue_"+k];s&&""!=s&&-1!=s&&(o[q]={},r&&""!=r?o[q][r]=s:o[q]=s)}console.log("查询条件:",o),async.auto({count:function(a){Schemas[e].count(o,function(b,c){a(b,c)})},search:function(a){Schemas[e].all({where:o,order:j,skip:f,limit:g},function(b,c){a(b,c)})}},function(c,d){if(c)b.send({error:c});else{var e={};e.iTotalRecords=d.count,e.iTotalDisplayRecords=d.count,e.sEcho=a.body.sEcho,e.aaData=d.search,b.send(e)}})},posts.xls2all=function(a,b,c,d){};