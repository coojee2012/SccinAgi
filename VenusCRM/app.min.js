/*! SccinCRM 2015-03-15 */
"use strict";var domain=require("domain"),serverDm=domain.create();global.Venus={},serverDm.on("error",function(a){delete a.domain,console.error("应用程序发生异常：",a.stack)}),serverDm.run(function(){function a(a,b,c){var d=a.headers["user-agent"];if(/MSIE\s+(\d+)\.\d+/.test(d)){var e=RegExp.$1;9>e?(r.locals.jquery="1.11.0",r.locals.html5='<script src="/js/bootstrap/html5shiv.js"></script>'):(r.locals.jquery="2.1.0",r.locals.html5="")}else r.locals.jquery="2.1.0",r.locals.html5="";c()}function b(a,b,c,d){d(a)}function c(a,b,c,d){b.xhr?(o.error(a),c.send(500,{error:"服务器发生异常!"})):d(a)}function d(a,b,c){o.error("errorHandler:",a);var d=require("util");c.status(500),c.render("error.html",{error:d.inspect(a)})}function e(a,b){var c=g.readdirSync(a),d=c.length,e=null;b&&""!==b||(b="/");for(var h=0;d>h;h++)e=c[h],f(a+"/"+e,b)}function f(a,b){g.stat(a,function(c,d){if(c)o.error(c);else if(d.isFile()){var f=h.basename(a,".js"),g=(h.dirname(a),h.basename(h.dirname(a))),i=h.basename(__filename,".js");f!=i&&f.indexOf(g)<0&&(r.all(b+f,function(c,d,e){var g="index",h=require(a);h&&h[c.route.method]&&"function"==typeof h[c.route.method][g]?h[c.route.method][g](c,d,e,b+f):d.render("404.html")}),r.all(b+f+"/:ooo",function(c,d,e){var g="index";c.param("ooo")&&""!==c.param("ooo")&&(g=c.param("ooo")),o.debug(a);var h=require(a);h&&h[c.route.method]&&"function"==typeof h[c.route.method][g]?h[c.route.method][g](c,d,e,b+f):d.render("404.html")}))}else if(d.isDirectory()){var j=h.basename(a);e(a,b+j+"/")}else o.error("unknow type of file")})}{var g=(require("lodash"),require("fs")),h=require("path"),i=require("express"),j=require("express-partials"),k=require("http"),l=(require("https"),require("node-conf")),m=(require(__dirname+"/asterisk/asmanager").nami,require("connect-jugglingdb")(i),require("./database/jdmysql").schema,require(__dirname+"/modules/DBModules").Dbs,l.load("app")),n=m.debug?"src":"build",o=require("./lib/logger").logger("web"),p=require("./lib/logger").log4js,q=k.createServer(),r=({key:g.readFileSync(__dirname+"/PCA/server.key"),cert:g.readFileSync(__dirname+"/PCA/server.crt")},i());i.Router()}r.set("port",process.env.PORT||m.hostport),r.set("views",h.join(__dirname,"views")),r.set("view engine","ejs"),r.set("env",m.env),r.engine("html",require("ejs").renderFile),r.use(j()),r.use(i.favicon()),r.use(p.connectLogger(o,{level:p.levels.DEBUG,format:":method :url"})),r.use(i.bodyParser({uploadDir:__dirname+"/public/uploads"})),r.use(require("stylus").middleware(h.join(__dirname,"public"))),r.use(i["static"](h.join(__dirname,"public"))),r.use(i.json()),r.use(i.urlencoded()),r.use(i.methodOverride()),r.use(i.cookieParser()),r.use(i.session({secret:"11366846@qq.com"})),"development"===r.get("env")&&(o.info("当前运行于开发环境！"),r.use(i.errorHandler({showStack:!0,dumpExceptions:!0}))),"production"===r.get("env"),r.use(a),r.use(function(a,b,c){var d=domain.create();d.on("error",function(a){c(a)}),d.run(function(){c()})}),r.use(r.router),r.get("/",function(a,b){b.redirect("/index")}),e(__dirname+"/routes/"+n+"/"),r.use(function(a,b){b.render("404.html",{status:404,title:""})}),r.use(b),r.use(c),r.use(d),r.locals({title:m.appname,phone:m.phone,email:m.email}),q.maxHeadersCount=0,q.setMaxListeners(0),q.on("request",r),q.on("error",function(a){o.error("发生错误: ",a)}),module.parent||q.listen(r.get("port"),function(){o.info("成功启动四川建设网语音拨打服务: "+r.get("port"))}),module.exports=q});