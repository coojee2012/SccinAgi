/*! 路由处理程序 2015-04-10 */
var path=require("path"),guid=require("guid"),conf=require("node-conf").load("app"),basedir=Venus.baseDir,Schemas=require(basedir+"/database/schema").Schemas,moment=require("moment"),async=require("async"),logger=require(basedir+"/lib/logger").logger("web"),fs=require("fs"),commfun=require(basedir+"/lib/comfun"),nami=require(basedir+"/asterisk/asmanager").nami,util=require("util"),AsAction=require("nami").Actions,gets={},posts={};module.exports={get:gets,post:posts},gets.index=function(a,b,c,d){var e=require("os"),f=e.type(),g=e.release(),h=a.query.displayStart||0;if(/Windows_\w+/.test(f))b.render("pbx/Sounds/list.html",{osinfo:f+" "+g,used:"-.-",unused:"-.-",baifenbi:"1%",baseurl:d,pageIndex:h,where:util.inspect(commfun.searchContions(a.query.where)),modename:"pbxSounds"});else{var i,j,k,l="1%",m=require("child_process").exec;i=m("df -h /home",function(e,i,m){console.log("stdout: "+i),console.log("stderr: "+m);var n=i.split("\n");if(n.length>0){var o=n[2].split(/\s+/);console.log(o),j=o[1],k=o[2],l=o[4]}else j="-.-",k="-.-";null!==e?c(e):b.render("pbx/Sounds/list.html",{osinfo:f+" "+g,used:j,unused:k,baifenbi:l,pageIndex:h,where:util.inspect(commfun.searchContions(a.query.where)),baseurl:d,modename:"pbxSounds"})})}},gets.create=function(a,b,c,d){b.render("pbx/Sounds/create.html",{baseurl:d})},gets.edit=function(a,b,c,d){var e=a.query.id;async.auto({find:function(a){Schemas.pbxSounds.find(e,function(b,c){b||null==c?a("编辑查找不存在！",c):a(b,c)})}},function(c,e){b.render("pbx/Sounds/edit.html",{baseurl:d,displayStart:a.query.displayStart||0,where:a.query.where||"",inst:e.find})})},posts["delete"]=function(a,b,c,d){var e=a.body.id;Schemas.pbxSounds.find(e,function(a,c){var d={};if(a)d.success="ERROR",d.msg="查询数据发生异常,请联系管理员！",b.send(d);else if(c){var e="/var/lib/asterisk/sounds/cn/"+c.folder+"/",f=c.filename,g=c.extname,h=e+f+"."+g;fs.unlink(h,function(a){a?(logger.error(a),d.success="ERROR",d.msg="删除语音文件发生异常,请联系管理员！！",b.send(d)):c.destroy(function(a){a?(logger.error(a),d.success="ERROR",d.msg="删除数据库记录发生异常,请联系管理员！！",b.send(d)):(d.success="OK",d.msg="删除成功！",b.send(d))})})}else d.success="ERROR",d.msg="没有找到需要删除的数据！",b.send(d)})},posts.save=function(a,b,c,d){var e=conf.asounds,f={};for(var g in a.body)/^tmp(\S+)/.test(g)||(f[g]=a.body[g]);var h=a.body.tmpdir,i=a.body.tmpname,j=e+a.body.folder+"/",k=a.body.filename,l=a.body.extname;async.auto({isHaveCheck:function(a){Schemas.pbxSounds.find(f.id,function(b,c){a(b,c)})},renamefile:["isHaveCheck",function(a,b){if(""!==h&&""!==i&&null===b.isHaveCheck){var c=h+i+"."+l,d=j+k+"."+l;logger.info("新增语音文件-需要将文件移动到:"+d),fs.rename(c,d,function(b){b?a(b,null):fs.unlink(c,function(){b?a(b,null):a(null,null)})})}else if(null!==b.isHaveCheck||""===h&&""===i)if(null===b.isHaveCheck||""===h&&""===i)if(null!==b.isHaveCheck&&""!==h&&""!==i){var f=e+b.isHaveCheck.folder+"/",g=b.isHaveCheck.filename,m=b.isHaveCheck.extname,n=f+g+"."+m,c=h+i+"."+l,d=j+k+"."+l;logger.info("修改语音文件-需要将文件移动到:"+d),fs.unlink(n,function(b){b?a(b,null):fs.rename(c,d,function(b){b?a(b,null):fs.unlink(c,function(b){b?a(b,null):a(null,null)})})})}else a(null,null);else a(null,null);else a("请先上传或录制语音文件！",null)}],createNew:["renamefile",function(a,b){null!==b.isHaveCheck?a(null,-1):(f.id=guid.create(),f.label="",Schemas.pbxSounds.create(f,function(b,c){b?a(b,-1):a(b,c)}))}],updateOld:["renamefile",function(a,b){null===b.isHaveCheck?a(null,-1):Schemas.pbxSounds.update({where:{id:f.id},update:f},function(b,c){console.log(c),a(b,c)})}]},function(a,c){var d={success:"",id:"",msg:""};c.createNew&&-1!==c.createNew?c.createNew.isValid(function(a){a?(d.success="OK",d.msg="新增成功！",d.id=c.createNew.id):(d.success="ERROR",d.msg="服务器感知到你提交的数据非法，不予受理！")}):c.updateOld&&-1!==c.updateOld?(d.success="OK",d.msg="修改成功！",d.id=c.isHaveCheck.id):a&&(logger.error(a),d.success="ERROR",d.msg="保存数据发生异常,请联系管理员！"),b.send(d)})},posts.delfile=function(a,b,c,d){var e=a.body.filename;if(""==e)b.send({success:"ERROR",msg:"删除的文件名为空！"});else{var f=basedir+"/public/uploads/ "+e;console.log(f),fs.exists(f,function(a){a?fs.unlink(f,function(a){b.send({success:"OK ",msg:"删除成功！"})}):b.send({success:"ERROR ",msg:"文件不存在！"})})}},posts.recordByExten=function(a,b,c,d){var e=a.body.exten,f=new Date,g=f.getTime(),h="filepath=/tmp/"+g+".wav",i="LOCAL/"+e+"@sub-recordByExten",j="sub-recordByExten-callback",k=new AsAction.Originate;k.Channel=i,k.Async=!0,k.Account=e,k.CallerID=e,k.Context=j,k.Variable=h,k.Exten=e,console.log(k),nami.connected?nami.send(k,function(a){b.send("Success"==a.response||"success"==a.response?{success:"OK",tmpname:g,tmpdir:"/tmp/"}:{success:"ERROR",msg:a.message})}):b.send({success:"ERROR",msg:"AMI连接中断！"})},posts.listenByPhone=function(a,b,c,d){var e=a.body.dirtype||"sounds",f=a.body.folder,g=a.body.filename,h=a.body.exten;/^\/\S+/.test(f)||("sounds"===e?f=conf.asounds+f:"monitor"===e&&(f=conf.monitor+f));var i="filepath="+f+g,j="LOCAL/"+h+"@sub-listenByPhone",k="sub-listenByPhone-callback",l=new AsAction.Originate;l.Channel=j,l.Async=!0,l.Account=h,l.CallerID=h,l.Context=k,l.Variable=i,l.Exten=h,console.log(l),nami.connected?nami.send(l,function(a){b.send("Success"==a.response||"success"==a.response?{success:"OK",msg:"响铃后摘机收听！ "}:{success:"ERROR",msg:a.message})}):b.send({success:"ERROR",msg:"AMI连接中断！"})};