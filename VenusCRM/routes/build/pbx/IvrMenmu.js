/*! 路由处理程序 2015-04-09 */
function delsthes(a,b){async.each(a,function(a,b){a.destroy(function(a){b(a?a:null)})},function(a){b(a)})}function orderactions(a,b){var c=0;async.whilst(function(){return c<a.length},function(b){c++,Schemas.pbxIvrActions.update({where:{id:a[c-1]},update:{ordinal:c}},function(a,c){b(a,c)})},function(a){b(a)})}var guid=require("guid"),async=require("async"),_=require("lodash"),conf=require("node-conf"),basedir=Venus.baseDir,Schemas=require(basedir+"/database/schema").Schemas,logger=require(basedir+"/lib/logger").logger("web"),commfun=require(basedir+"/lib/comfun"),util=require("util"),gets={},posts={};module.exports={get:gets,post:posts};var checkFun={};checkFun.id=function(a,b){a&&""!=a?Schemas.pbxIvrMenmu.findOne({where:{id:a}},function(a,c){b.send(a?{info:"后台验证发生错误！",status:"n"}:null!=c?{info:"已经存在！",status:"n"}:{info:"验证通过！",status:"y"})}):b.send({info:"输入不能为空！",status:"n"})},posts.checkAjax=function(a,b,c,d){var e=a.body.param,f=a.body.name;checkFun[f](e,b)},gets.index=function(a,b,c,d){b.render("."+d+"/list.html",{baseurl:d,pageIndex:a.query.displayStart||0,where:util.inspect(commfun.searchContions(a.query.where)),modename:"pbxIvrMenmu"})},gets.create=function(a,b,c,d){b.render("."+d+"/create.html",{baseurl:d,modename:"pbxIvrMenmu"})},gets.edit=function(a,b,c,d){var e=a.query.id;async.auto({findUser:function(a){Schemas.pbxIvrMenmu.find(e,function(b,c){b||null==c?a("IVR不存在！",c):a(b,c)})}},function(c,e){b.render("."+d+"/edit.html",{baseurl:d,displayStart:a.query.displayStart||0,where:a.query.where||"",inst:e.findUser})})},gets.ivrtree=function(a,b,c,d){var e=a.query.id;async.auto({findAction:function(a){var b=new Array;for(var c in Schemas.pbxIvrActions.relations)b.push(c);Schemas.pbxIvrActions.all({include:b,where:{ivrnumber:e},order:"ordinal ASC"},function(b,c){for(var d=new Array,e=0;e<c.length;e++){var f={};f.id=c[e].id,f.text=c[e].__cachedRelations.Actmode.modename,f.icon=c[e].__cachedRelations.Actmode.iconame,d.push(f)}console.log(d),a(b,d)})},findMenu:function(a){Schemas.pbxIvrMenmu.find(e,function(b,c){b||null==c?a("IVR不存在！",c):a(b,c)})},getActmodes:function(a){Schemas.pbxIvrActMode.all({order:"id ASC"},function(b,c){a(b,c)})},findInputs:function(a){Schemas.pbxIvrInputs.all({where:{ivrnumber:e},order:["general ASC","inputnum ASC"]},function(b,c){a(b,c)})}},function(a,c){b.render("."+d+"/ivrtree.html",{layout:!1,baseurl:d,modename:"pbxIvrMenmu",inst:c.findAction,actmods:c.getActmodes,inputs:c.findInputs,menuInst:c.findMenu})})},posts.reorder=function(a,b,c,d){var e=a.body.neworders.split(",");orderactions(e,function(a){b.send(a?{success:"ERROR",msg:"排序失败！"}:{success:"OK",msg:"排序成功！"})})},posts.addaction=function(a,b,c,d){var e=a.body.modeid,f=a.body.ivrnum;async.auto({count:function(a){Schemas.pbxIvrActions.count({ivrnumber:f},function(b,c){console.log(c),a(b,c)})},create:["count",function(a,b){var c={ivrnumber:f,ordinal:b.count+1,actmode:""+e,args:""};Schemas.pbxIvrActions.create(c,function(b,c){a(b,c)})}]},function(a,c){b.send(a?{success:"ERROR",id:"",msg:a}:{success:"OK",id:c.create.id})})},posts.delaction=function(a,b,c,d){var e=a.body.ids.split(","),f=a.body.ivrnum;e.length>0?async.auto({find:function(a){Schemas.pbxIvrActions.all({where:{id:{inq:e},ivrnumber:f}},function(b,c){a(b,c)})},del:["find",function(a,b){delsthes(b.find,a)}],findtwo:["del",function(a,b){Schemas.pbxIvrActions.all({where:{ivrnumber:f},order:"ordinal asc"},function(b,c){a(b,_.map(c,function(a){return a.id}))})}],order:["findtwo",function(a,b){orderactions(b.findtwo,a)}]},function(a,c){b.send(a?{success:"ERROR",msg:"删除发生错误:"+a}:{success:"OK",msg:"删除成功！"})}):b.send({success:"ERROR",msg:"没有什么需要删除的！"})},posts.delinput=function(a,b,c,d){var e=a.body.ids.split(","),f=a.body.ivrnum;e.length>0?async.auto({find:function(a){Schemas.pbxIvrInputs.all({where:{id:{inq:e},ivrnumber:f}},function(b,c){a(b,c)})},del:["find",function(a,b){delsthes(b.find,a)}]},function(a,c){b.send(a?{success:"ERROR",msg:"删除发生错误:"+a}:{success:"OK",msg:"删除成功！"})}):b.send({success:"ERROR",msg:"没有什么需要删除的！"})},posts.save=function(a,b,c,d){var e={};for(var f in a.body)e[f]=a.body[f];async.auto({isHaveCheck:function(a){e.id&&""!==e.id?Schemas.pbxIvrMenmu.find(e.id,function(b,c){a(b,c)}):a("IVR号码不能为空",-1)},createNew:["isHaveCheck",function(a,b){null!==b.isHaveCheck?a(null,-1):Schemas.pbxIvrMenmu.create(e,function(b,c){a(b,c)})}],updateOld:["isHaveCheck",function(a,b){null===b.isHaveCheck?a(null,-1):Schemas.pbxIvrMenmu.update({where:{id:e.id},update:e},function(b,c){a(b,c)})}],defaultinputs:["createNew",function(a,b){if(-1===b.createNew)a(null,-1);else{var c=[{ivrnumber:e.id,inputnum:"101",generaltype:"timeout",general:1},{ivrnumber:e.id,inputnum:"102",generaltype:"invalidkey",general:1},{ivrnumber:e.id,inputnum:"103",generaltype:"retry",general:1}];async.forEach(c,function(a,b){Schemas.pbxIvrInputs.create(a,function(a,c){b(a,c)})},function(b,c){a(b,c)})}}],addlocalnum:["createNew",function(a,b){commfun.addlocalnum(b.createNew.id,"ivr",1,a)}]},function(a,c){var d={success:"",id:"",msg:""};-1!==c.createNew?c.createNew.isValid(function(a){a?(d.success="OK",d.msg="新增成功!",d.id=c.createNew.id):(d.success="ERROR",d.msg="服务器感知到你提交的数据非法，不予受理！")}):-1!==c.updateOld?(d.success="OK",d.msg="修改成功!",d.id=e.id):a&&(console.log(a),d.success="ERROR",d.msg="保存数据发生异常,请联系管理员！"),b.send(d)})},posts["delete"]=function(a,b,c,d){var e=a.body.id;async.auto({findivrmenmu:function(a){Schemas.pbxIvrMenmu.find(e,function(b,c){b||null===c?a("查找IVR发生错误！",null):"是"===c.isreadonly?a("系统只读，不能被删除！",null):a(null,c)})},delmenmu:["findivrmenmu",function(a,b){b.findivrmenmu.destroy(function(b){a(b,null)})}],findivractions:["delmenmu",function(a,b){Schemas.pbxIvrActions.all({where:{ivrnumber:e}},function(b,c){a(b,c)})}],findivrinputs:["delmenmu",function(a,b){Schemas.pbxIvrInputs.all({where:{ivrnumber:e}},function(b,c){a(b,c)})}],delactions:["findivractions",function(a,b){delsthes(b.findivractions,a)}],delinputs:["findivrinputs",function(a,b){delsthes(b.findivrinputs,a)}],dellocalnum:["delmenmu",function(a,b){commfun.dellocalnum(e,a)}]},function(a,c){var d={};a?(d.success="ERROR",d.msg="查询数据发生异常,请联系管理员！"):(d.success="OK",d.msg="删除成功！"),b.send(d)})},posts.addinput=function(a,b,c){var d=a.body.ivrnum,e=a.body.keynum;async.auto({check:function(a){Schemas.pbxIvrInputs.all({where:{ivrnumber:d,inputnum:e}},function(b,c){b?a("数据库查询发生异常！",null):c.length>0?a("已经存在同样的按键！",null):a(null,null)})},add:["check",function(a,b){Schemas.pbxIvrInputs.create({ivrnumber:d,inputnum:e,generaltype:"1"},function(b,c){a(b,c)})}]},function(a,c){b.send(a?{success:"ERROR",id:"",msg:a}:{success:"OK",id:c.add.id,msg:"保存成功！"})})};