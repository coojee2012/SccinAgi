/*! AGI 2016-08-19 */
function str2obj(a){var b={};if(a&&""!==a){var c=a.split("&");for(var d in c){var e=c[d].split("=");b[e[0]]=e[1]}}return b}var _=require("lodash"),async=require("async"),fs=require("fs"),AsAction=require("nami").Actions,moment=require("moment"),guid=require("guid"),conf=require("node-conf").load("fastagi"),routing=function(a){this.context=a.context,this.schemas=a.Schemas,this.agiconf=a.agiconf,this.nami=a.nami,this.args=a.args,this.logger=a.logger,this.vars=a.vars,this.sessionnum=guid.create(),this.ivrlevel=0,this.transferlevel=0,this.lastinputkey="",this.routerline="",this.activevar={}},commonfun={};module.exports=routing,routing.prototype.NextDial=function(a,b,c){var d=this,e=(d.context,d.schemas),f=(d.logger,d.nami);async.auto({getPhones:function(b){e.crmCallPhone.all({where:{callRecordsID:a,State:0}},function(a,c){b(a,c)})},startnewdial:["getPhones",function(c,d){if(d.getPhones&&d.getPhones.length>0){var e="LOCAL/200@sub-outgoing",g="sub-outgoing-callback",h=new AsAction.Originate;h.Channel=e,h.Async=!0,h.Account=a,h.CallerID=66899866,h.Context=g,h.Variable="callrecordid="+a+",keynum="+b,h.Exten=200,f.connected?f.send(h,function(a){c(null,a)}):(f.open(),f.send(h,function(a){c(null,a)}))}else c(null,"over")}]},function(a,b){c(a,b)})},routing.prototype.NoCome=function(a,b){var c=this,d=c.context,e=c.schemas,f=c.logger;async.auto({saveDialResult:function(b){try{e.crmDialResult.update({where:{id:a},update:{Result:2,State:1}},function(a,c){b(a,c)})}catch(c){f.error("记录确认不参加评标发生异常:",c),b("记录确认不参加评标发生异常！",null)}},voiceNotice:["saveDialResult",function(a,b){d.Playback("nosure",function(b,c){d.hangup(function(b,c){d.end(),a(b,c)})})}]},function(a,c){b(a,c)})},routing.prototype.SureCome=function(a,b,c,d,e){var f=this,g=f.context,h=f.schemas,i=f.logger;async.auto({saveDialResult:function(b){try{h.crmDialResult.update({where:{id:a},update:{Result:1,State:1}},function(a,c){b(a,c)})}catch(c){i.error("保存拨打结果发生异常:",c),b("保存拨打结果发生异常！",null)}},voiceNotice:["saveDialResult",function(a,e){var f=function(e){async.auto({playvoice:function(a){try{var c=e>0?"-hard":"-sure";g.GetData("/home/share/"+b+c,5e3,1,function(b,c){a(b,c)})}catch(d){i.error("语音通知确认评标发生异常:",d),a("语音通知确认评标发生异常！",null)}},checkInput:["playvoice",function(a,b){try{var f=b.playvoice.result;f.replace(/\s+/,""),h.crmUserKeysRecord.create({id:guid.create(),Key:f,keyTypeID:"111111",callLogID:c.id},function(b,c){switch(f){case d[2]:e++,a(b,{count:e,key:f});break;case"timeout":g.Playback("timeout",function(b,c){e++,a(b,{count:e,key:f})});break;default:g.Playback("inputerror",function(b,c){e++,a(b,{count:e,key:f})})}})}catch(j){i.error("语音通知确认评标记录按键发生异常:",j),a("语音通知确认评标记录按键发生异常！",null)}}]},function(b,c){"-1"===c.checkInput.key?a(null,-1):c.checkInput.count<3?f(c.checkInput.count):g.Playback("waiteout",function(a,b){g.hangup(function(a,b){g.end()})})})},j=0;f(j)}]},function(a,b){e(a,b)})},routing.prototype.VoiceMail=function(a,b){var c=this,d=c.context,e=c.schemas,f=(c.nami,c.logger),g=c.args,h=c.vars;if(a&&""!==a||(a=g.number),b&&"function"==typeof b||(b=function(a,b){a?d.hangup(function(a,b){}):d.end()}),a&&""!==a){var i="/var/spool/asterisk/monitor/voicemail/"+a+"/",j=guid.create(),k="wav";async.auto({checkOlds:function(a){console.log(e.pbxRcordFile),e.pbxRcordFile.all({where:{lable:"voicemail"},order:"cretime DESC",skip:60},function(b,c){a(b,c)})},delOld:["checkOlds",function(a,b){b.checkOlds.length>0?commonfun.delrecordfiles(e,b.checkOlds,a):a(null,null)}],playusevoice:["delOld",function(a,b){d.Playback("vm-intro",a)}],record:["playusevoice",function(a,b){var c=60,e="sxk",f=k,g=10;d.Record(i+j+"."+f,g,c,e,function(b,c){a(b,c)})}],playGoodbye:["record",function(a,b){d.Playback("vm-goodbye",a)}],getFileSize:["record",function(a,b){commonfun.getfilestate(i+j+"."+k,function(b,c){var d=0;b?f.error(b):d=c.size,a(null,d)})}],insertdb:["getFileSize",function(a,b){e.pbxRcordFile.create({filename:j,lable:"voicemail",folder:i,extname:k,callnumber:h.agi_callerid,extennum:g.called,filesize:b.getFileSize},function(b,c){a(b,c)})}]},function(a,c){a&&f.error("语音信箱：",a),b(a,c)})}else d.end()},routing.prototype.addQueueMember=function(){var a=this,b=a.context,c=(a.schemas,a.nami,a.logger,a.args);a.vars;async.auto({addAgent:function(a){b.AddQueueMember(c.queuenum,c.agent,function(b,c){a(b,c)})}},function(a,b){})},routing.prototype.agi=function(a,b){},routing.prototype.blacklist=function(a,b){var c=this,d=c.context,e=c.schemas,f=(c.nami,c.logger),g=c.args,h=c.vars;a&&""!==a&&a!==g.called||(a=h.agi_callerid),b&&"function"==typeof b||(b=function(a,b){a?d.hangup(function(a,b){}):d.end()});try{e.pbxBlackList.find(a,function(a,c){a?(f.error("黑名单处理发生异常:",a),b(a,null)):null!==c?d.hangup(b):b(null,null)})}catch(i){f.error("黑名单处理发生异常:",i),b(i,null)}},routing.prototype.calloutback=function(){var a=this,b=a.context,c=a.schemas,d=null,e=null,f=null,g=a.logger;a.args.routerline="扩展应用";var h=a.args,i=a.vars;async.auto({AddCDR:function(b){c.pbxCdr.create({id:a.sessionnum,caller:i.agi_callerid,called:h.called,accountcode:i.agi_accountcode,routerline:h.routerline,srcchannel:i.agi_channel,uniqueid:i.agi_uniqueid,threadid:i.agi_threadid,context:i.agi_context,agitype:i.agi_type,lastapptime:moment().format("YYYY-MM-DD HH:mm:ss"),lastapp:"calloutback",answerstatus:"CALLBACK"},function(a,c){b(a,c)})},getCallrcordsId:function(a){b.getVariable("callrecordid",function(b,c){var e=/(\d+)\s+\((.*)\)/,f=null;e.test(c.result)&&(f=RegExp.$1,d=RegExp.$2),a(b,d)})},getProjMoveID:["getCallrcordsId",function(a,b){c.crmCallRecords.find(d,function(b,c){b||null===c?a(b,c):(f=c.ProjMoveID,a(null,c.ProjMoveID))})}],getKeyNum:["getCallrcordsId",function(a,c){b.getVariable("keynum",function(b,c){var d=/(\d+)\s+\((.*)\)/,f=null;d.test(c.result)&&(f=RegExp.$1,e=RegExp.$2.split("|"),g.debug("keyNum:",e)),a(b,e)})}],getPhones:["getKeyNum",function(a,b){c.crmCallPhone.all({where:{callRecordsID:d,State:1}},function(b,c){a(b,c)})}],updateCallRecords:["getKeyNum",function(a,b){c.crmCallRecords.update({where:{id:d},update:{CallState:2}},function(b,c){a(b,c)})}],getKey:["getPhones","getProjMoveID","updateCallRecords",function(h,i){var j=i.getPhones[0],k=function(){c.crmDialResult.update({where:{id:d},update:{Result:3,State:1}},function(a,c){b.stream&&b.stream.readable&&b.Playback("waiteout",function(a,d){b.hangup(function(a,d){b.end(),h(a,c)})})})},l=function(m){m>2?k():b.GetData("/home/share/"+i.getProjMoveID+"-notice",5e3,1,function(i,n){if(i)h(i,null);else{var o=n.result;if(o.replace(/\s+/,""),c.crmUserKeysRecord.create({id:guid.create(),Key:o,keyTypeID:"111111",callLogID:j.id},function(a,b){}),o===e[0]){g.debug("专家确定参加评标！");var p=function(i){i>2?k():b.GetData("suercomttip",5e3,1,function(n,o){if(n)h(n,null);else{g.debug("再次确认参加收键:",o);var q=o.result;q.replace(/\s+/,""),c.crmUserKeysRecord.create({id:guid.create(),Key:q,keyTypeID:"111111",callLogID:j.id},function(a,b){}),""===q||"#"===q?a.SureCome(d,f,j,e,function(a,b){h(a,b)}):"*"===q?(m++,l(m)):/timeout/.test(q)&&3>i?b.Playback("timeout",function(a,b){a?h(a,null):(i++,p(i))}):"-1"!==q&&3>i?b.Playback("inputerror",function(a,b){a?h(a,null):(i++,p(i))}):k()}})};p(0)}else if(o===e[1]){g.debug("专家确定不参加评标！");var q=function(e){e+0>2?k():(g.debug("专家确定不参加评标次数：",e),b.GetData("canneltip",5e3,1,function(f,g){if(f)h(f,null);else{var i=g.result;i.replace(/\s+/,""),c.crmUserKeysRecord.create({id:guid.create(),Key:i,keyTypeID:"111111",callLogID:j.id},function(a,b){}),""===i||"#"===i?a.NoCome(d,function(a,b){h(a,b)}):"*"===i?(m++,l(m)):/timeout/.test(i)?b.Playback("timeout",function(a,b){a?h(a,null):(e++,q(e))}):"-1"!==i?b.Playback("inputerror",function(a,b){a?h(a,null):(e++,q(e))}):k()}}))};q(0)}else o===e[2]?(g.debug("专家重听评标信息！"),m++,l(m)):/timeout/.test(o)?(g.debug("等待专家按键超时！"),b.Playback("timeout",function(a,b){a?h(a,null):(m++,l(m))})):"-1"!==o?(g.debug("专家按键错误！"),b.Playback("inputerror",function(a,b){a?h(a,null):(m++,l(m))})):k()}})};l(0)}]},function(a,c){a&&b.stream&&b.stream.readable&&b.hangup(function(a,c){b.end()})})},routing.prototype.channelMax=function(a){async.auto({},function(b,c){a(b,c)})},commonfun.guid=function(){return guid.create()},commonfun.unixtime=function(){var a=new Date,b=a.getTime(),c=100*Math.random();return b.toString()+"-"+c.toString()},commonfun.mkdir=function(a,b){fs.exists(a,function(c){c?b(null,a):fs.mkdir(a,function(c){c?b("无法创建需要的目录："+a,null):b(null,a)})})},commonfun.getPort=function(a){var b=/\w+:\/\/([^\/]+)(\/)?/i,c=a.match(b),d=c[1].indexOf(":");return-1!==d?(c[1]=c[1].substr(d+1),parseInt(c[1])):"https"===a.toLowerCase().substr(0,5)?443:80},commonfun.getHost=function(a){var b=/\w+:\/\/([^\/]+)(\/)?/i,c=a.match(b),d=c[1].indexOf(":");return-1!==d&&(c[1]=c[1].substring(0,d)),c[1]},commonfun.getPath=function(a){var b=/\w+:\/\/([^\/]+)(\/.+)(\/$)?/i,c=a.match(b);return c?c[2]:"/"},commonfun.delrecordfiles=function(a,b,c){var d=this,e=require("fs"),f=a.pbxRcordFile;async.each(b,function(a,b){d.delbyid(f,a.id,function(c,d){if(c)b(c);else{var f=a.folder+a.filename+a.extname;e.unlink(f,b)}})},function(a){c(a,null)})},commonfun.delbyid=function(a,b,c){a.find(b,function(a,b){a?c(a,null):b?b.destroy(function(a){a?c(a,null):c(null,null)}):c(null,null)})},commonfun.getfilestate=function(a,b){var c=require("fs");c.stat(a,function(a,c){b(a,c)})},routing.prototype.conference=function(a,b,c){},routing.prototype.dialExtenFail=function(a,b,c){var d=this,e=(d.context,d.schemas),f=(d.nami,d.logger);d.args,d.vars;async.auto({getFailOptions:function(b){e.pbxExtension.find(a,function(a,c){a||null==c?b("呼叫失败处理获取分机信息发生异常！",-1):b(null,c)})},doFail:["getFailOptions",function(a,b){var c=str2obj(b.getFailOptions.failed);f.debug("呼叫失败处理:",b.getFailOptions.failed),c.deailway&&""!==c.deailway&&"function"==typeof c.deailway?d[c.deailway](c.number,function(b,c){a(b,c)}):d.hangup("",function(b,c){a(b,c)})}]},function(a,b){c(a,-b)})},routing.prototype.diallocal=function(a,b){var c=this,d=c.context,e=c.schemas,f=(c.nami,c.logger),g=c.args;c.vars;a&&""!==a||(a=g.localnum),b&&"function"==typeof!b||(b=function(a,b){a?d.hangup(function(a,b){}):d.end()}),async.auto({updateCDR:function(a){e.pbxCdr.update({where:{id:c.sessionnum},update:{lastapptime:moment().format("YYYY-MM-DD HH:mm:ss"),lastapp:"本地呼叫"}},function(b,c){a(b,c)})},findLocal:["updateCDR",function(b,d){e.pbxLocalNumber.findOne({where:{id:a}},function(d,e){if(d&&b(d,e),f.debug(e),null!=e)f.debug("本地处理："+e.localtype),c[e.localtype](a,e.assign,function(a,c){b(a,c)});else{f.debug("本地默认处理拨打IVR200");var g=conf.defaultivr||200;c.ivr(g,1,function(a,c){b(a,c)})}})}]},function(a,c){b(a,c)})},routing.prototype.dialout=function(a,b){var c=this,d=c.context,e=c.schemas,f=(c.nami,c.logger),g=c.args,h=c.vars;async.auto({updateCDR:function(a){e.pbxCdr.update({where:{id:c.sessionnum},update:{called:g.called,lastapptime:moment().format("YYYY-MM-DD HH:mm:ss"),lastapp:"呼叫外部"}},function(b,c){a(b,c)})},findLine:["updateCDR",function(b,c){e.pbxTrunk.find(a,function(a,c){a||null==c?b("没有找到可以呼出的外线",-1):b(null,c)})}],updatePopScreen:["updateCDR",function(a,b){e.pbxScreenPop.update({where:{id:h.agi_callerid},update:{callernumber:h.agi_callerid,callednumber:g.called,sessionnumber:c.sessionnum,status:"waite",routerdype:2,poptype:"dialout",updatetime:moment().format("YYYY-MM-DD HH:mm:ss")}},function(b,c){a(b,c)})}],automonitor:["findLine",function(a){c.sysmonitor("呼出",a)}],dial:["automonitor",function(a,b){var i=b.findLine.trunkproto,j=b.findLine.trunkdevice,k=g.called;e.pbxCallProcees.create({callsession:c.sessionnum,caller:h.agi_callerid,called:g.called,routerline:g.routerline,passargs:"trunkproto="+i+"&called="+k+"&trunkdevice="+j,processname:"呼叫外线",doneresults:""},function(a,b){a&&f.error("记录呼叫处理过程发生异常：",a)});var l="";l="PRI"===i||"FXO"===i?"DAHDI/g"+j:i+"/"+j,d.Dial(l+"/"+k,conf.timeout,conf.dialoptions,function(b,c){b?a(b,c):d.getVariable("DIALSTATUS",function(b,c){a(null,c)})})}],afterdial:["dial",function(a,b){var d=/(\d+)\s+\((\w+)\)/,i=null;d.test(b.dial.result)&&(i=RegExp.$2),f.debug("应答状态：",i),e.pbxCallProcees.create({callsession:c.sessionnum,caller:h.agi_callerid,called:g.called,routerline:g.routerline,passargs:"",processname:"呼叫外线结束",doneresults:"anwserstatus="+i},function(a,b){a&&f.error("记录呼叫处理过程发生异常：",a)}),e.pbxCdr.update({where:{id:c.sessionnum},update:{lastapptime:moment().format("YYYY-MM-DD HH:mm:ss"),answerstatus:i}},function(a,b){a&&f.error("通话结束后更新通话状态发生异常！",a)}),a(null,1)}]},function(a,c){b(a,c)})},routing.prototype.dodefault=function(a,b){var c=this,a=c.context;c.schemas,c.nami,c.logger,c.args,c.vars;a.hangup(function(b,c){console.log("Hangup success:",c),a.end()})},routing.prototype.extension=function(a,b,c){var d=this,e=d.context,f=d.schemas,g=(d.nami,d.logger),h=d.vars;d.args.called=a;d.args;async.auto({updateCDR:function(b){f.pbxCdr.update({where:{id:d.sessionnum},update:{lastapptime:moment().format("YYYY-MM-DD HH:mm:ss"),accountcode:a,called:a,lastapp:"拨打分机"}},function(a,c){b(a,c)})},updateScreenPop:function(b){f.pbxScreenPop.update({where:{id:a},update:{callernumber:h.agi_callerid,callednumber:a,sessionnumber:d.sessionnum,status:"waite",routerdype:1,poptype:"diallocal",updatetime:moment().format("YYYY-MM-DD HH:mm:ss")}},function(a,c){b(a,c)})},extenmonitor:function(a){var b="呼入";"呼出"==d.routerline&&(b="呼出"),d.sysmonitor(b,a)},dial:["updateCDR","extenmonitor",function(c,f){var h=str2obj(b),i=h.extenproto||"SIP",j=h.timeout||"60";j=parseInt(j),h.transnum&&/\d+/.test(h.transnum)?(g.debug("当前呼叫转移参数：",h.transway,h.transnum),h.transway&&"function"==typeof d[h.transway]&&d.transferlevel<10?(g.debug("当前呼叫转移层数：",d.transferlevel),d.transferlevel++,d[h.transway](h.transnum,function(a,b){a&&g.error("呼叫转移过程中发生异常",a),c(null,{result:"1 (TRANSFER)"})})):c("呼叫转移方式指定错误或呼叫转移循环层级达到10",-1)):e.Dial(i+"/"+a,j,"tr",function(a,b){g.debug("拨打分机返回结果：",b),a?c(a,b):e.getVariable("DIALSTATUS",function(a,b){c(null,b)})})}],afterdial:["dial",function(b,c){var e=/(\d+)\s+\((\w+)\)/,h=null;e.test(c.dial.result)&&(h=RegExp.$2),g.debug("应答状态：",h),f.pbxCdr.update({where:{id:d.sessionnum},update:{lastapptime:moment().format("YYYY-MM-DD HH:mm:ss"),answerstatus:h}},function(a,b){a&&g.error("通话结束后更新通话状态发生异常！",a)}),"CANCEL"===h?(g.debug("主叫叫直接挂机！"),b("主叫直接挂机！",-1)):"TRANSFER"===h?(g.debug("被叫开启了呼叫转移！"),b("被叫开启了呼叫转移！",-1)):"ANSWER"!==h?d.dialExtenFail(a,h,function(a,c){b(a,c)}):(g.debug("应答成功。"),b(null,1))}]},function(a,b){c(a,b)})},routing.prototype.findqueuemember=function(){var a=this,b=a.context,c=a.schemas,d=(a.nami,a.logger),e=a.args,f=(a.vars,e.localnum);async.auto({findLocal:function(a,b){c.pbxLocalNumber.findOne({where:{id:f}},function(b,c){b&&a(b,c),null!=c?a(null,c.assign):a("在本地号码中没有找到队列成员号码。",null)})},dial:["findLocal",function(a,c){var e=str2obj(c.findLocal),g=e.extenproto||"SIP",h=e.timeout||"60";h=parseInt(h),b.Dial(g+"/"+f,h,"tr",function(c,e){d.debug("拨打队列分机返回结果：",e),c?a(c,e):b.getVariable("DIALSTATUS",function(b,c){a(null,c)})})}],afterdial:["dial",function(a,b){var c=/(\d+)\s+\((\w+)\)/,e=null;c.test(b.dial.result)&&(e=RegExp.$2),d.debug("拨打队列分机应答状态：",e),"CANCEL"===e?(d.debug("主叫叫直接挂机！"),a("主叫直接挂机！",-1)):"TRANSFER"===e?(d.debug("被叫开启了呼叫转移！"),a("被叫开启了呼叫转移！",-1)):"ANSWER"!==e?a("拨打队列分机应答不成功！",-1):(d.debug("拨打队列分机应答成功。"),a(null,1))}]},function(a,c){d.error(a),b.end()})},routing.prototype.getAsConf=function(a,b){var c=this,d=c.context,e=(c.schemas,c.nami),f=(c.logger,c.args);c.vars;if(a&&""!==a||(a=f.filename),b&&"function"==typeof b||(b=function(a,b){a?d.hangup(function(a,b){}):d.end()}),a&&""!==a){var g=new AsAction.GetConfigJson;g.Filename=a+".conf",e.connected?e.send(g,function(a){console.log(a.json),"Success"===a.response?b(null,a.json):b(null,{})}):(e.open(),e.send(g,function(a){console.log(a.json),"Success"===a.response?b(null,a.json):b(null,{})}))}else d.end()},routing.prototype.hangup=function(a,b){var c=this,d=c.context;c.schemas,c.nami,c.logger,c.args,c.vars;d.hangup(function(a,c){b(a,c)})},routing.prototype.ivr=function(a,b,c){var d=this,e=d.context,f=d.schemas,g=(d.nami,d.logger),h=d.args,i=d.vars;a&&""!==a||(a=h.ivrnum),b&&""!==b||(b=h.action),c&&"function"==typeof c||(c=function(a,b){return a?void e.hangup(function(a,b){}):0}),d.ivrlevel>50?c("IVR嵌套过深",-1):(g.debug("当前IVR嵌套层数:",d.ivrlevel),d.ivrlevel++,async.auto({updateCDR:function(a){f.pbxCdr.update({where:{id:d.sessionnum},update:{lastapptime:moment().format("YYYY-MM-DD HH:mm:ss"),lastapp:"自动语音应答处理"}},function(b,c){a(b,c)})},getIVR:["updateCDR",function(b,c){f.pbxIvrMenmu.find(a,function(a,c){a||null==c?b("查找IVR发生错误或没有找到IVR",null):b(a,c)})}],getIVRActions:["getIVR",function(a,b){b.getIVR.actions({where:{},include:"Actmode",order:["ordinal asc"]},function(b,c){a(b,c)})}],getIVRInputs:["getIVR",function(a,b){b.getIVR.inputs({where:{}},function(b,c){a(b,c)})}],Answer:["getIVRActions","getIVRInputs",function(a,b){e.answer(function(b,c){b&&g.error(b),g.debug("IVR应答结果：",c),a(b,c)})}],checkaction:["Answer",function(a,c){b||(b=1),g.debug("获取到的IVR动作编号:",b),/^\d+$/g.test(b)?a(null,b):f.pbxIvrActions.find(b,function(c,d){c||null==d?a("获取IVR动作顺序号错误！",null):(b=d.ordinal,a(null,b))})}],action:["checkaction",function(c,e){g.debug("开始执行IVR动作"),f.pbxCallProcees.create({callsession:d.sessionnum,caller:i.agi_callerid,called:h.called,routerline:h.routerline,passargs:"ivrnum="+a+"&action="+b,processname:"呼叫自动语音应答处理",doneresults:""},function(a,b){a&&g.error("记录呼叫处理过程发生异常：",a)}),d.ivraction(b,e.getIVRActions,e.getIVRInputs,function(a,b){c(a,b)})}]},function(a,b){c(a,b)}))},routing.prototype.ivraction=function(a,b,c,d){var e=this,f=e.context,g=e.schemas,h=e.nami,i=e.logger,j=e.args,k=e.vars;if(i.debug("进入IVR动作执行流程编号:",a),a>0&&a<=b.length){i.debug(b[a-1].__cachedRelations.Actmode);var l=b[a-1].__cachedRelations.Actmode,m=str2obj(b[a-1].args);i.debug("Action 参数:",m),async.auto({AddProcees:function(c){g.pbxCallProcees.create({callsession:e.sessionnum,caller:k.agi_callerid,called:j.called,routerline:j.routerline,passargs:"actionid="+a+"&"+b[a-1].args,processname:l.modename,doneresults:""},function(a,b){a&&i.error("记录呼叫处理过程发生异常：",a),c(a,b)})},Action:function(d){if(i.debug("actionid:",a),"播放语音"===l.modename){i.debug("IVR播放语音");var n=m.folder+"/"+m.filename;if(m.specfile&&""!==m.specfile){var o=m.specfile;if(/\%(\S+)\%/.test(o)){var p=RegExp.$1,q=e.activevar[p];i.debug("播放语音上下文环境"+p+":",q),o=o.replace(/\%(\S+)\%/,q),o=o.replace(/\%/g,"")}i.debug("播放语音的绝对路径：",o),n=o}if("true"!==m.interruptible)i.debug("准备播放语音。"),f.Playback(n,function(a,b){i.debug("Playback:",b),d(a,b)});else{var r=3;m.retrytime&&/\d+/.test(m.retrytime)&&(r=parseInt(m.retrytime));var s=5e3;m.timeout&&/\d+/.test(m.timeout)&&(s=1e3*parseInt(m.timeout));var t=m.failivrnum,u=0;m.failactid&&/\d+/.test(m.failactid)&&(u=parseInt(m.failactid));var v=function(a){async.auto({playinfo:function(a){f.GetData(n,s,1,function(b,c){i.debug("按键返回：",c),a(b,c)})},checkinput:["playinfo",function(b,d){var f=d.playinfo.result;f=f.replace(/\s+|\(|\)/g,""),i.debug("用户按键：",f),e.ivrinput(f,c,function(c,d){0==d?(a++,b(c,{count:a,key:f})):b(c,{count:100,key:f})})}]},function(a,b){i.debug("当前循环次数：",b.checkinput),a?d(a,-1):"-1"===b.checkinput.key?d("对方主动挂机。",-1):b.checkinput.count<r?(i.debug("按键错误或等待按键超时，须重试！"),v(b.checkinput.count)):f.Playback("b_bye",function(a,b){d("超过允许最大的按键等待次数或错误次数",-1)})})},w=0;v(w)}}else if("检查号码归属地"===l.modename){var x=e.vars.agi_callerid,y=m.quhao,z=m.doneway,A=m.number;if(A&&""!==A&&y&&""!==y)if(y=y.split(","),/^(013|015|018|13|15|18)(\d{5})\d{4}$/.test(x)){var B=RegExp.$1+""+RegExp.$2;B=B.replace(/^0/,""),g.pbxMobileCode.findOne({where:{number7:B}},function(a,b){if(a||null===b)d("查询号码库发生异常或为找到对应的号码库",null);else{var c=b.quhao;c=c.replace(/\D+/,""),_.contains(y,c)?e[z](A,d):d(null,null)}})}else if(/(^0[1-2]\d|^0[3-9]\d\d)\d{7,8}$/.test(x)){var C=RegExp.$1;_.contains(y,C)?e[z](A,d):d(null,null)}else d(null,null);else d("归属地匹配参数有误！",null)}else if("发起录音"===l.modename){var D=m.maxduration||60,E=m.options||"s",F=m.format||"wav",G=m.silence||10,H="";if(/\<\%(\w+)\%\>(\S+)/.test(m.varname)){var I=RegExp.$1,J=RegExp.$2;""!==I&&"function"==typeof commonfun[I]?(H+=commonfun[I](),H+="-"+J):H=J}else H=m.varname||"";if(H&&""!==H){H+="."+F;var K="/var/spool/asterisk/monitor/IVR/"+b[a-1].ivrnumber+"/";async.auto({buildDir:function(a){commonfun.mkdir(K,function(b,c){b?a(null,"/var/spool/asterisk/monitor/"):a(null,c)})},createFile:["buildDir",function(a,b){a(null,K+H)}],recording:["createFile",function(a,b){f.Record(b.createFile,G,D,E,function(b,c){a(b,c)})}],checkRecording:["recording",function(a,b){try{f.getVariable("RECORD_STATUS",function(b,c){i.debug("获取录音状态：",c);var d=/(\d+)\s+\((.*)\)/,e=null,f=null;d.test(c.result)&&(e=RegExp.$1,f=RegExp.$2),a(b,f)})}catch(c){i.error(c),a("获取录音状态：",null)}}],addRecord:["checkRecording",function(a,b){g.pbxRcordFile.create({id:e.sessionnum,filename:H,extname:F,callnumber:k.agi_callerid,extennum:j.called,folder:K},function(b,c){a(b,c)})}]},function(a,b){d(a,b)})}else d("录音文件名不能为空！",null)}else if("播放录音"===l.modename){var F=m.format||"wav",K="/var/spool/asterisk/monitor/IVR/"+b[a-1].ivrnumber+"/",H="";if(/\<\%(\w+)\%\>(\S+)/.test(m.varname)){var I=RegExp.$1,J=RegExp.$2;""!==I&&"function"==typeof commonfun[I]?(H+=commonfun[I](),H+="-"+J):H=J}else H=m.varname||"";f.Playback(K+H+"."+F,function(a,b){d(a,b)})}else if("录制数字字符"===l.modename){i.debug("准备开始录制数字字符。");var L=20,M="",s=1e4;m.timeout&&/\d+/.test(m.timeout)&&m.timeout+0>0&&(s=1e3*m.timeout);var N=m.ivrnumber,O=m.actionid||1;m.maxdigits&&/\d+/.test(m.maxdigits)&&(L=parseInt(m.maxdigits)),0>=L?d(null,1):async.auto({GetKey:function(a){var b=m.beep,c=function(){f.waitForDigit(s,function(b,d){if(i.debug("录制数字字符返回：",d),b)a(b,d);else if("0"==d.result)e.ivr(N,O,a);else{var f=String.fromCharCode(d.result);if("#"!==f&&(M+=f),i.debug("录制到数字字符:"+M),M.length<L&&"#"!==f)c();else{m.addbefore&&"true"===m.addbefore&&(M=e.lastinputkey+M);var g="lastwaitfordigit";m.varname&&""!==m.varname&&(g=m.varname),e.activevar[g]=M,i.debug("保存到变量"+g+"的数字字符:"+e.activevar[g]),a(null,M)}}})};"true"===b?f.Playback("beep",function(a,b){c()}):c()}},function(a,b){d(a,b)})}else if("读出数字字符"===l.modename){i.debug("准备读出数字字符。");var P="lastwaitfordigit";m.varname&&""!==m.varname&&(P=m.varname);var Q=e.activevar[P];i.debug("准备从变量"+P+"读出数字字符:"+Q),m.digits&&/\d+/.test(m.digits)&&(Q=m.digits),/\d+/.test(Q)?async.auto({saydigits:function(a){i.debug("需要读出数字字符:",Q),f.saydigits(Q,function(b,c){i.debug("读出数字字符返回结果：",c),a(b,c)})}},function(a,b){d(a,b)}):d("没有需要读取的数字",-1)}else if("数字方式读出"===l.modename){var P="lastwaitfordigit";m.varname&&""!==m.varname&&(P=m.varname);var Q=e.activevar[P];m.digits&&/\d+/.test(m.digits)&&(Q=m.digits),i.debug("数学读出：",Q),/\d+/.test(Q)?e.sayNumber(Q,function(a,b){d(a,b)}):d("没有需要读取的数字",-1)}else if("读出日期时间"===l.modename){var R="",S="";S=m.sayway&&"date"===m.sayway?"YYYYMMDD":m.sayway&&"time"===m.sayway?"HHmm":"YYYYMMDD HHmm","true"===m.saynow?R=moment().format(S):""!==m.fromvar?(R=e.activevar[m.fromvar],R=moment(R,["YYYY-MM-DD HH:mm","YY-MM-DD HH:mm","MM-DD-YYYY HH:mm","DD-MM HH:mm","DD-MM-YYYY HH:mm"]).format(S)):""!==m.fromstr&&(R=moment(m.fromstr,["YYYY-MM-DD HH:mm","YY-MM-DD HH:mm","MM-DD-YYYY HH:mm","DD-MM HH:mm","DD-MM-YYYY HH:mm"]).format(S)),""!==R?(i.debug("读出的日期：",R),e.sayDateTime(R,m.sayway,function(a,b){i.debug("读出的日期时间完成！",a),d(a,b)})):d("没有可以读取的日期时间！",-1)}else if("检测日期"===l.modename){var T=!0,U=(moment().year(),moment().month()+1),V=moment().date(),W=moment().isoWeekday(),X=moment().hour(),Y=moment().minute();moment().second();if(m.months&&""!==m.months){var Z=m.months.split(",");T=_.contains(Z,U.toString())?!0:!1}if(m.dates&&""!==m.dates&&T){var $=m.dates.split(",");T=_.contains($,V.toString())?!0:!1}if(m.weeks&&""!==m.weeks&&T){var aa=m.weeks.split(",");T=_.contains(aa,W.toString())?!0:!1}if(m.hours&&""!==m.hours&&T){var ba=m.hours.split(",");T=_.contains(ba,X.toString())?!0:!1}if(m.minutes&&""!==m.minutes&&T){var ca=m.minutes.split(",");T=_.contains(ca,Y.toString())?!0:!1}var N=m.ivrnumber,O=m.actionid||1;T?e.ivr(N,O,d):d(null,null)}else if("变量判断"===l.modename)if(i.debug("进行变量判断"),m.varname&&""!==m.varname){var P=m.varname,da="";i.debug("变量值："+e.activevar[P]+",期望值:"+m.varval),e.activevar[P]&&(da=e.activevar[P]+"");var ea=m.varval+"",fa=""===m.checkway?"eq":m.checkway;if("eq"===fa&&ea==da){var N=m.ivrnumber,O=m.actionid||1;e.ivr(N,O,d)}else if("neq"===fa&&ea!=da){var N=m.ivrnumber,O=m.actionid||1;e.ivr(N,O,d)}else if("gt"===fa&&ea>da){var N=m.ivrnumber,O=m.actionid||1;e.ivr(N,O,d)}else if("lt"===fa&&da>ea){var N=m.ivrnumber,O=m.actionid||1;e.ivr(N,O,d)}else d(null,null)}else d(null,null);else if("主叫变换"===l.modename){var ga=m.optiontype,A=m.number;ga&&A?("replace"===ga?e.vars.agi_callerid=A:"addbefore"===ga?e.vars.agi_callerid=A+e.vars.agi_callerid:"append"===ga&&(e.vars.agi_callerid=e.vars.agi_callerid+A),d(null,null)):d(null,null)}else if("拨打号码"===l.modename){var ha=e.activevar.lastwaitfordigit;m.varname&&""!==m.varname&&(ha=e.activevar[m.varname]),m.digits&&""!==m.digits&&(ha=m.digits),/\d+/.test(ha)?m.dialway&&""!==m.dialway?async.auto({dial:function(a){i.debug("拨打号码："+m.dialway+"/"+ha),e[m.dialway](ha,function(b,c){a(b,c)})}},function(a,b){d(a,b)}):(i.debug("非法拨打方式"),d("非法拨打方式",-1)):(i.debug("需要拨打的号码有误。"),d("需要拨打的号码有误。",-1))}else if("跳转到语音信箱"===l.modename){var A=m.number;e.VoiceMail(A,d)}else if("跳转到IVR菜单"===l.modename){var N=m.ivrnumber,O=m.actionid||1;N&&""!==N?e.ivr(N,O,d):d("无法跳转到指定IVR，IVR编号为空！",null)}else if("WEB交互接口"===l.modename){var ia=m.url,ja=m.methods,s=m.timeout||10,ka=m.programs,la=m.varprex||"webapp-",ma=m.doneivrnum,na=m.doneivractid||1,t=m.failivrnum,oa=m.failivractid||1,pa=m.timeoutivrnum,qa=m.timeoutivractid||1;if(!/^http/.test(ia)){var ra=conf.webAppPrev;ra=ra.replace(/\/+$/,""),ia=ia.replace(/^\/+/,""),ia=ra+"/"+ia}var sa="https"===ia.substring(0,ia.indexOf(":"))?"https":"http",ta=require(sa),E={host:commonfun.getHost(ia),hostname:commonfun.getHost(ia),port:commonfun.getPort(ia),path:commonfun.getPath(ia),rejectUnauthorized:!1,headers:{"Content-Type":"application/json","User-Agent":"BjExpert","User-key":"BjExpert"},method:ja};i.debug("Web交互接口访问设置：",E);var ua={},va="?";ka=ka.split(","),_(ka).forEach(function(a){var b=a.split("~"),c=b[0],d=b[1];if(/\%(\S+)\%/.test(d)){var f=RegExp.$1;ua[c]=d.replace(/\%(\S+)\%/,e.activevar[f]),va+=c+"="+d.replace(/\%(\S+)\%/,e.activevar[f])+"&"}else ua[c]=d,va+=c+"="+d+"&"}),async.auto({getChannelval:function(a){a(null,ua)},getData:["getChannelval",function(a,b){i.debug("WEB交互接口参数：",ua),ua=JSON.stringify(ua),"GET"===E.method.toUpperCase()&&(E.path=E.path+va);var c=ta.request(E,function(b){var c="";i.debug("STATUS: "+b.statusCode),i.debug("HEADERS: "+JSON.stringify(b.headers)),b.setEncoding("utf8"),b.on("data",function(a){i.debug("WEB交互接口获取到返回数据：",c),c+=a}),b.on("end",function(){i.debug("WEB交互接口执行了GetData！",c),a(null,c)})});c.on("error",function(b){i.error("WEB交互接口发生异常: ",b),a("error",null)}),c.setTimeout(1e3*s,function(){c.end(),i.error("WEB交互接口超时 "),a("timeout",null)}),c.write(ua+"\n"),c.end()}],setChannelVal:["getData",function(a,b){var c=b.getData;i.debug("WEB交互返回值：",c);var d=null;if("object"==typeof c)i.debug("WEB交互返回值是一个对象！"),d=c;else{i.debug("WEB交互返回值是一个字符串！");try{d=JSON.parse(c)}catch(f){i.error("WEB交互返回值不是一个有效的JSON数据：",c),d={},d.success=!1}}if(i.debug("WEB交互转换成对象：",d),d.success){i.debug("WEB交互转换逻辑成功！"),delete d.success;for(var g in d)e.activevar[la+g]=d[g];i.debug("当前上下文变量；",e.activevar),a(null,null)}else i.debug("WEB交互转换逻辑失败！"),a("fail",null)}]},function(a,b){a&&"fail"===a?e.ivr(t,oa,d):a||"timeout"===a?e.ivr(pa,qa,d):e.ivr(ma,na,d)})}else if("AGI扩展接口"===l.modename){var wa=m.addr,ka="?";_.forOwn(m,function(a,b){"addr"!==b&&(ka+=b+"="+a+"&")}),f.AGI(wa+ka,d)}else if("等待几秒"===l.modename){var xa=m.seconds;f.Wait(xa,d)}else if("播放音调"===l.modename){var ya=m.tonename,xa=m.seconds;async.auto({playtones:function(a){f.PlayTones(ya,a)},waitamoment:["playtones",function(a,b){f.Wait(xa,a)}],stopPlaytones:["waitamoment",function(a,b){f.StopPlayTones(a)}]},function(a,b){d(a,b)})}else"通道阀"===l.modename?async.auto({getActiveChannels:function(a){var b=m.trunkProto;if(i.debug("准备获取通道类型为:"+b+"的通道信息"),b&&""!==b){b=b.toLowerCase();var c=new AsAction.Command;c.Command=b+" show channels",h.connected?h.send(c,function(b){var c=b.lines.pop();a(null,c)}):(h.open(),h.send(c,function(b){a(null,b)}))}else a("无效通道协议。",-1)},dosth:["getActiveChannels",function(a,b){var c=b.getActiveChannels;c&&""!==c&&(c=c.split("\n")),i.debug("当前获取到"+m.trunkProto+"的通道信息:",c),30>=m.max?e.channelMax(function(b,c){a(b,c)}):a(null,1)}]},function(a,b){d(a,b)}):"黑名单"===l.modename?e.blacklist("",d):d("默认处理",-1)}},function(f,g){f?(i.error("执行IVR动作中发生错误：",f),d(f,-1)):(a++,e.ivraction(a,b,c,d))})}else i.debug("所有的动作执行完毕!"),d("所有的动作执行完毕",-1)},routing.prototype.ivrinput=function(a,b,c){var d=this,e=d.context,f=(d.schemas,d.nami,d.logger);d.args,d.vars;"-1"===a&&c("获取按键时一方挂机",-1);var g=null;d.lastinputkey=a;for(var h in b)if(b[h].inputnum===a){g=b[h];break}null!==g?(f.debug("找到对应的按键流程：",g),d.ivr(g.gotoivrnumber,g.gotoivractid,function(a,b){a&&f.debug("上层IVR返回了异常：",a),c(a,b)})):(f.debug("没有找到按键:",a),"timeout"===a?e.Playback("b_timeout",function(a,b){c(null,0)}):e.Playback("b_error",function(a,b){c(null,0)}))},routing.prototype.listenByPhone=function(){var a=this,b=a.context,c=(a.schemas,a.nami,a.logger),d=a.args;a.vars;async.auto({listening:function(a){b.Playback(d.filepath,function(b,d){c.debug("Playback:",d),a(b,d)})}},function(a,d){a?(c.error(a),c.debug("当前上下文状态："+b.state+"，上下文流是否可读："+b.stream.readable),b.stream&&b.stream.readable&&b.hangup(function(a,b){})):(c.debug("当前上下文状态："+b.state+"，上下文流是否可读："+b.stream.readable),b.stream&&b.stream.readable&&b.hangup(function(a,b){c.debug("来自自动挂机")}))})},routing.prototype.monitor=function(a,b){var c=this,d=c.context,e=(c.schemas,c.nami,c.logger);c.args,c.vars;"function"==typeof a&&(b=a,a=c.sessionnum+".wav"),d.MixMonitor(a,"","",function(a,c){a?(e.error("自动录音，发生错误：",a),b("自动录音发生异常.",a)):b(null,c)})},routing.prototype.pauseQueueMember=function(a,b,c){var d=this,e=d.context,f=(d.schemas,d.nami,d.logger,d.args),g=d.vars;async.auto({removeAgent:function(a){var b=f.queuenum||"",c=f.agent||g.agi_callerid;e.PauseQueueMember(b,"SIP/"+c+",0,"+c,function(b,c){a(b,c)})}},function(a,b){c(a,b)})},routing.prototype.queue=function(a,b,c){var d=this,e=d.context,f=d.schemas,g=(d.nami,d.logger);d.args,d.vars;async.auto({updateCDR:function(b){f.pbxCdr.update({where:{id:d.sessionnum},update:{lastapptime:moment().format("YYYY-MM-DD HH:mm:ss"),lastapp:"拨打队列"+a}},function(a,c){b(a,c)})},findQueue:function(b){f.pbxQueue.find(a,function(a,c){a||null==c?b("查找队列发生错误！",null):b(null,c)})},queue:["updateCDR","findQueue",function(b,c){var f=0==c.findQueue.queuetimeout?60:c.findQueue.queuetimeout;e.Queue(a,"tT","","",f,"agi://127.0.0.1/queueAnswered?queuenum="+a+"&sessionnum="+d.sessionnum,function(a,c){g.debug("队列拨打返回结果:",c),b(a,c)})}],getQueueStatus:["queue",function(a,b){e.getVariable("QUEUESTATUS",function(b,c){var d="",e=/(\d+)\s+\((.*)\)/,f=null;e.test(c.result)&&(f=RegExp.$1,d=RegExp.$2),g.debug("获取呼叫队列状态：",d),a(b,d)})}]},function(a,b){c(a,b)})},routing.prototype.queueAnswered=function(){var a=this,b=a.context,c=a.schemas,d=(a.nami,a.logger),e=a.args,f=a.vars;a.sessionnum=e.sessionnum;e.queuenum;d.debug("队列被接听:",f),async.auto({getAnswerMem:function(c){b.getVariable("MEMBERINTERFACE",function(b,e){var f="",g=/(\d+)\s+\((.*)\)/,h=null;g.test(e.result)&&(h=RegExp.$1,f=RegExp.$2),/\/(\d+)/.test(f)&&(f=RegExp.$1),d.debug("当前应答坐席：",f),a.args.called=f,c(b,f)})},updateCDR:["getAnswerMem",function(b,d){c.pbxCdr.update({where:{id:a.sessionnum},update:{answerstatus:"ANSWER",called:d.getAnswerMem,accountcode:d.getAnswerMem,lastapptime:moment().format("YYYY-MM-DD HH:mm:ss")}},function(a,c){b(a,c)})}],updatePop:["getAnswerMem",function(b,d){c.pbxScreenPop.update({where:{id:d.getAnswerMem},update:{callernumber:f.agi_callerid,callednumber:d.getAnswerMem,sessionnumber:a.sessionnum,status:"waite",routerdype:1,poptype:"dialqueue",updatetime:moment().format("YYYY-MM-DD HH:mm:ss")}},function(a,c){b(a,c)})}],automonitor:["getAnswerMem",function(b,c){a.sysmonitor("队列",b)}]},function(a,c){
b.end()})},routing.prototype.recordbyphone=function(){var a=this,b=a.context,c=(a.schemas,a.nami,a.logger),d=a.args;a.vars;async.auto({recording:function(a){var e=60,f="sxk",g=10;b.Record(d.filepath,g,e,f,function(b,d){c.error(d),a(b,d)})}},function(a,d){a?(c.error(a),c.debug("当前上下文状态："+b.state+"，上下文流是否可读："+b.stream.readable),b.stream&&b.stream.readable&&b.hangup(function(a,b){})):(c.debug("当前上下文状态："+b.state+"，上下文流是否可读："+b.stream.readable),b.stream&&b.stream.readable&&b.hangup(function(a,b){c.debug("来自自动挂机")}))})},routing.prototype.removeQueueMember=function(){var a=this,b=a.context,c=(a.schemas,a.nami,a.logger,a.args);a.vars;async.auto({removeAgent:function(a){b.RemoveQueueMember(c.queuenum,c.agent,function(b,c){a(b,c)})}},function(a,b){})},routing.prototype.router=function(){var a=this,b=a.context,c=a.schemas,d=(a.nami,a.logger),e=a.args,f=a.vars;a.routerline=e.routerline,async.auto({AddCDR:function(b){c.pbxCdr.create({id:a.sessionnum,caller:f.agi_callerid,called:e.called,accountcode:f.agi_accountcode,routerline:e.routerline,srcchannel:f.agi_channel,uniqueid:f.agi_uniqueid,threadid:f.agi_threadid,context:f.agi_context,agitype:f.agi_type,lastapptime:moment().format("YYYY-MM-DD HH:mm:ss"),lastapp:"呼叫路由处理",answerstatus:"NOANSWER"},function(a,c){b(a,c)})},MixMonitor:["AddCDR",function(a,b){a(null,null)}],GetRouters:["AddCDR",function(a,b){c.pbxRouter.all({where:{routerline:e.routerline},order:["proirety asc"]},function(b,c){a(b,c)})}],Route:["GetRouters",function(b,g){var h=null,i=null,j=!1;d.debug("该类型路由有：",g.GetRouters.length),async.eachSeries(g.GetRouters,function(a,b){if(d.debug("循环去匹配找到的路由规则：",a),j)d.debug("已经找到匹配的路由！"),b("已经找到匹配的路由！");else{if(f.agi_accountcode===a.callergroup||"all"===a.callergroup){d.debug("开始进行呼叫路由判断,主叫:",f.agi_callerid,",被叫:",e.called),j=!0;var c=new RegExp("^"+a.callerid),g=new RegExp("^"+a.callednum);"呼入"===a.routerline?(""===a.callerid||c.test(f.agi_callerid)||(j=!1),a.callerlen>0&&f.agi_callerid.length!==a.callerlen&&(j=!1)):"呼出"===a.routerline&&(""===a.callednum||g.test(e.called)||(j=!1),a.calledlen>0&&e.called.length!==a.calledlen&&(j=!1)),j&&(d.debug("路由匹配成功，开始进行替换操作"),""!==a.replacecallerid&&(f.agi_callerid=a.replacecallerid),a.replacecalledtrim>0&&(e.called=e.called.substr(a.replacecalledtrim)),""!==a.replacecalledappend&&(e.called=a.replacecalledappend+e.called),h=a.processmode,i="dialout"===h?a.processdefined:e.called)}b()}},function(g){j?(c.pbxCallProcees.create({callsession:a.sessionnum,caller:f.agi_callerid,called:e.called,routerline:e.routerline,passargs:"processmode="+h+"&processdefined="+i,processname:"呼叫路由处理",doneresults:"匹配到呼叫路由"},function(a,b){a&&d.error("记录呼叫处理过程发生异常：",a)}),a[h](i,function(a,c){b(a,c)})):(c.pbxCallProcees.create({callsession:a.sessionnum,caller:f.agi_callerid,called:e.called,routerline:e.routerline,passargs:"",processname:"呼叫路由处理",doneresults:"未找到匹配的路由！"},function(a,b){a&&d.error("记录呼叫处理过程发生异常：",a)}),b("未找到匹配的路由！",1))})}]},function(a,c){a?(d.error(a),d.debug("当前上下文状态："+b.state+"，上下文流是否可读："+b.stream.readable),b.stream&&b.stream.readable&&b.hangup(function(a,b){})):(d.debug("当前上下文状态："+b.state+"，上下文流是否可读："+b.stream.readable),b.stream&&b.stream.readable&&b.hangup(function(a,b){d.debug("来自自动挂机")}))})},routing.prototype.sayDateTime=function(a,b,c){var d=this,e=d.context,f=(d.schemas,d.nami,d.logger),g=d.args;d.vars;if(a&&""!==a||(a=g.datetime),b&&""!==b||(b=g.sayway),f.debug("CALLBACK",c,typeof c),c&&"function"==typeof c||(c=function(a,b){f.debug("IVR动作-读出日期时间，执行了自定义回调函数!"),a?e.hangup(function(a,b){}):e.end()}),a&&""!==a){var h=a.split(/\s+/),i=h[0],j=i.substr(0,4),k=i.substr(4,2);k=k.replace(/^0/,"");var l=i.substr(6,2);l=l.replace(/^0/,"");var m=h[1]||"0000",n=m.substr(0,2);n=n.replace(/^0/,"");var o=m.substr(2,2);o=o.replace(/^0/,""),f.debug("年-月-日-时-分：",j+"-"+k+"-"+l+"-"+n+"-"+o),"date"===b?async.auto({sayyear:function(a){e.saydigits(j,a)},sayYYYY:["sayyear",function(a,b){e.Playback("digits/year",a)}],saymonth:["sayYYYY",function(a,b){e.saynumber(k,a)}],sayMM:["saymonth",function(a,b){e.Playback("digits/month",a)}],sayday:["sayMM",function(a,b){e.saynumber(l,a)}],sayDD:["sayday",function(a,b){e.Playback("digits/day",a)}]},function(a,b){c(a,b)}):"time"===b?async.auto({sayhour:function(a){e.saynumber(n,a)},sayHH:["sayhour",function(a,b){e.Playback("digits/hour",a)}],sayminute:["sayHH",function(a,b){e.saynumber(o,a)}],saymm:["sayminute",function(a,b){e.Playback("digits/minute",a)}]},function(a,b){f.debug("读出时间日期完成：",a),c(a,b)}):async.auto({sayyear:function(a){e.saydigits(j,a)},sayYYYY:["sayyear",function(a,b){e.Playback("digits/year",a)}],saymonth:["sayYYYY",function(a,b){e.saynumber(k,a)}],sayMM:["saymonth",function(a,b){e.Playback("digits/month",a)}],sayday:["sayMM",function(a,b){e.saynumber(l,a)}],sayDD:["sayday",function(a,b){e.Playback("digits/day",a)}],sayhour:["sayDD",function(a){e.saynumber(n,a)}],sayHH:["sayhour",function(a,b){e.Playback("digits/hour",a)}],sayminute:["sayHH",function(a,b){e.saynumber(o,a)}],saymm:["sayminute",function(a,b){e.Playback("digits/minute",a)}]},function(a,b){f.debug("读出时间日期完成!",a),c(a,b)})}else c("无效的日期时间参数！",-1)},routing.prototype.sayNumber=function(a,b){var c=this,d=c.context,e=(c.schemas,c.nami,c.logger,c.args);c.vars;a&&""!==a||(a=e.number),"function"==typeof a&&(b=a),b&&"function"==typeof!b||(b=function(a,b){a?d.hangup(function(a,b){}):d.end()}),d.saynumber(a,function(a,c){b(a,c)})},routing.prototype.sccincallout=function(){var a=this,b=a.context,c=a.schemas,d=a.args.callRecordsID,e=(a.nami,null),f=a.logger;a.args.routerline="扩展应用";var g=a.args,h=a.vars;async.auto({AddCDR:function(b){c.pbxCdr.create({id:a.sessionnum,caller:h.agi_callerid,called:g.called,accountcode:h.agi_accountcode,routerline:g.routerline,srcchannel:h.agi_channel,uniqueid:h.agi_uniqueid,threadid:h.agi_threadid,context:h.agi_context,agitype:h.agi_type,lastapptime:moment().format("YYYY-MM-DD HH:mm:ss"),lastapp:"sccincallout",answerstatus:"NOANSWER"},function(a,c){b(a,c)})},getCallrcordsId:function(a){try{b.getVariable("callrecordid",function(b,c){f.debug("获取呼叫记录编号：",c);var e=/(\d+)\s+\((.*)\)/,g=null;e.test(c.result)&&(g=RegExp.$1,d=RegExp.$2),a(b,d)})}catch(c){f.error(c),a("获取呼叫记录编号发生异常！",null)}},getKeyNum:["getCallrcordsId",function(a){try{b.getVariable("keynum",function(b,c){f.debug("获取有效按键：",c);var d=/(\d+)\s+\((.*)\)/,g=null;d.test(c.result)&&(g=RegExp.$1,e=RegExp.$2),a(b,e)})}catch(c){f.error(c),a("通道变量获取有效按键发生异常！",null)}}],getPhones:["getKeyNum",function(a,b){try{c.crmCallPhone.all({where:{callRecordsID:d,State:0}},function(b,c){a(b,c)})}catch(e){f.error(e),a("获取需要拨打的电话号码发生异常！",null)}}],updateCallRecords:["getPhones",function(a,b){try{b.getPhones&&b.getPhones.length>0?c.crmCallRecords.update({where:{id:d},update:{CallState:1}},function(b,c){a(b,c)}):a("未有找到电话号码",b)}catch(e){f.error("更新呼叫记录表发生异常:",e),a("更新呼叫记录表发生异常！",null)}}],updateDialResult:["getPhones",function(a,b){try{b.getPhones&&b.getPhones.length>0?c.crmDialResult.update({where:{id:d},update:{State:1}},function(b,c){a(b,c)}):a(null,null)}catch(e){f.error("更新呼叫结果表发生异常:",e),a("更新呼叫结果表发生异常！",null)}}],Dial:["getPhones","updateDialResult","updateCallRecords",function(a,e){if(e.getPhones&&e.getPhones.length>0)async.auto({updateCallPhone:function(a){try{c.crmCallPhone.update({where:{id:e.getPhones[0].id},update:{State:1}},function(b,c){a(b,c)})}catch(b){f.error("更新电话记录表发生异常:",b),a("更新电话记录表发生异常！",null)}},addCallLog:function(a){try{c.crmCallLog.create({Phone:e.getPhones[0].Phone,callphone:e.getPhones[0]},function(b,c){a(b,c)})}catch(b){f.error("添加呼叫日志发生异常:",b),a("添加呼叫日志发生异常！",null)}},dial:["addCallLog","updateCallPhone",function(a){try{b.Dial(conf.line+e.getPhones[0].Phone,conf.timeout,conf.dialoptions,function(c,d){c?a(c,d):(console.log(b),b.getVariable("DIALSTATUS",function(b,c){a(null,c)}))})}catch(c){f.error("产生拨打发生异常:",c),a("产生拨打发生异常！",null)}}],dialStatus:["dial",function(a,b){try{var d=/(\d+)\s+\((\w+)\)/,e=null;d.test(b.dial.result)&&(e=RegExp.$2),c.crmUserKeysRecord.create({id:guid.create(),Key:e,keyTypeID:"111111",calllog:b.addCallLog},function(b,c){a(b,c)})}catch(g){f.error("获取拨打状态发生异常:",g),a("获取拨打状态发生异常！",null)}}]},function(b,c){a(b,c)});else try{c.crmDialResult.update({where:{id:d},update:{Result:109,State:1}},function(b,c){a(b,c)})}catch(g){f.error("保存拨打结果发生异常:",g),a(g,null)}}]},function(e,g){var h=function(a){try{c.crmDialResult.update({where:{id:d},update:{Result:a,State:1}},function(a,b){})}catch(b){f.error("保存拨打结果发生异常:",b)}},i=function(a){b.stream&&b.stream.readable&&b.hangup(function(b,c){f.debug(a)})};if(e)f.error("外呼程序发生异常：",e),h(110),i("没有找到需要拨打的号码"),f.error("没有找到需要拨打的号码，挂机！");else{var j=g.Dial.dialStatus.Key;c.pbxCdr.update({where:{id:a.sessionnum},update:{lastapptime:moment().format("YYYY-MM-DD HH:mm:ss"),answerstatus:j}},function(a,b){a&&f.error("通话结束后更新通话状态发生异常！",a)}),"CONGESTION"===j?(h(100),i("被叫拒绝接听！")):"CHANUNAVAIL"===j?(h(101),i("号码无效！")):"NOANSWER"===j?(h(102),i("无应答！")):"BUSY"===j?(h(103),i("电话忙！")):"DONTCALL"===j?(h(104),i("被叫转移电话1！")):"TORTURE"===j?(h(105),i("被叫转移电话2")):"INVALIDARGS"===j?(h(106),i("无效的呼叫参数！")):"CANCEL"===j?(h(107),i("呼叫取消")):"ANSWER"!==j?(h(108),i("其他")):f.debug("准备开始播放语音文件。")}})},routing.prototype.sysmonitor=function(a,b){var c=this,d=c.context,e=c.schemas,f=(c.nami,c.logger),g=c.args,h=c.vars;"function"==typeof a&&(b=a,a=""),async.auto({checkMonitorWay:function(b){var c={id:{neq:""}};"呼入"===a?(c.recordin="是",c.members={like:"%"+g.called+"%"}):"呼出"===a?(c.recordout="是",c.members={like:"%"+h.agi_callerid+"%"}):"队列"===a?(c.recordqueue="是",c.members={like:"%"+g.called+"%"}):b(null,{wayName:"sysauto",keepfortype:"按时间",keepforargs:90}),c&&null!==c.members&&e.pbxAutoMonitorWays.findOne({where:c},function(a,c){b(a,c)})},buildForder:["checkMonitorWay",function(a,b){if(null!==b.checkMonitorWay){var c=require("fs"),d=b.checkMonitorWay.wayName,e="/var/spool/asterisk/monitor/"+d;c.exists(e,function(b){b?a(null,e+"/"):c.mkdir(e,"0777",function(b){b?a("无法创建录音需要的目录："+e,null):(c.chmodSync(e,"0777"),a(null,e+"/"))})})}else a("不需要录音！",null)}],findHasRecords:["checkMonitorWay",function(a,b){if(null!==b.checkMonitorWay)if("按时间"===b.checkMonitorWay.keepfortype){var c={};c.id={neq:""};var d=moment().subtract("days",b.checkMonitorWay.keepforargs).format("YYYY-MM-DD");c.cretime={lte:d},e.pbxRcordFile.all({where:c},function(b,c){a(b,c)})}else"按条数"===b.checkMonitorWay.keepfortype?e.pbxRcordFile.count(null,function(c,d){c?a(c,[]):d>b.checkMonitorWay.keepforargs?e.pbxRcordFile.all({skip:0,limit:d-b.checkMonitorWay.keepforargs},function(b,c){a(b,c)}):a(null,[])}):a(null,[]);else a("不需要录音！",[])}],handleHasRecords:["findHasRecords",function(a,b){async.each(b.findHasRecords,function(a,b){var c=a.folder+a.filename+"."+a.extname;fs.exists(c,function(a){a?fs.unlink(c,function(a){b(a)}):b(null)})},function(b){b?f.error(b):a(null,null)})}],addRecords:["buildForder",function(a,b){var d=c.sessionnum,f=g.called,i=h.agi_callerid;e.pbxRcordFile.create({filename:d,extname:"wav",calltype:c.routerline,lable:b.checkMonitorWay.wayName,extennum:f,folder:b.buildForder,callnumber:i},function(b,c){a(b,c)})}],monitor:["addRecords",function(a,b){var e=c.sessionnum+".wav";d.MixMonitor(b.buildForder+e,"ab","",function(b,c){b?a("自动录音发生异常.",b):a(null,c)})}]},function(a,c){a?(f.error("自动录音，发生错误：",a),b(null,a)):b(null,null)})},routing.prototype.unPauseQueueMember=function(a,b,c){var d=this,e=d.context,f=(d.schemas,d.nami,d.logger,d.args),g=d.vars;b&&""!==b||(b=f.assign),a&&""!==a||(action=f.queuenum),c&&"function"==typeof c||(c=function(a,b){a?e.hangup(function(a,b){}):e.end()}),async.auto({removeAgent:function(a){var b=f.queuenum||"",c=f.agent||g.agi_callerid;e.UnpauseQueueMember(b,"SIP/"+c+",0,"+c,function(b,c){a(b,c)})}},function(a,b){c(a,b)})},routing.prototype.voiceNoticeCallback=function(){var a=this,b=a.context,c=(a.schemas,a.nami,a.logger,a.args);a.vars;b.Playback("/home/share/"+c.fileID+"-api",function(a,c){a?b.hangup(function(a,b){}):b.end()})};