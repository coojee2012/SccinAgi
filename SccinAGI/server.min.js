/*! SccinAGI 2014-05-07 */
var AGI=require("./lib/index"),nami=require(__dirname+"/asterisk/asmanager").nami,conf=require("node-conf"),logconf=conf.load("log4js"),agiconf=conf.load("fastagi"),moment=require("moment"),routing=require("./smartAgi/src/Routings"),Schemas=require("./database/schema").Schemas,log4js=require("log4js");log4js.configure(logconf,agiconf);var logger=log4js.getLogger("agi");logger.setLevel("DEBUG");var Schemas=require("./database/schema").Schemas,server=AGI.createServer(function(a){logger.debug("当前上下文状态："+a.state+"，上下文流是否可读："+a.stream.readable);var b=new routing({context:a,Schemas:Schemas,agiconf:agiconf,nami:nami,args:null,logger:logger,vars:null});server.getConnections(function(a,b){logger.info("当前服务器连接数："+b)}),server.on("error",function(a){logger.error(a)}),a.on("variables",function(a){var c=a.agi_network_script.split("?"),d=c[0],e={};if(c[1]&&""!==c[1]){var f=c[1].split("&");for(var g in f){var h=f[g].split("=");e[h[0]]=h[1]}}logger.debug(a),b.args=e,b.vars=a,"function"==typeof b[d]?b[d]():b.dodefault(),logger.info("捕获到来自"+a.agi_callerid+"的新呼叫， 呼叫编号为: "+a.agi_uniqueid)}),a.on("response",function(a){logger.info("捕获到监听事件返回的结果：",a)}),a.on("hangup",function(){logger.info("发生挂机事件."),b.args.routerline?(logger.info("正常呼叫中心流程，记录挂机时间."),Schemas.pbxCdr.update({where:{id:b.sessionnum},update:{alive:"no",endtime:moment().format("YYYY-MM-DD HH:mm:ss")}},function(b){b&&logger.error(b),a.end()})):a.end()}),a.on("error",function(b){logger.info("AGI ERROR:",b),a.end()}),a.on("close",function(a){logger.info("AGI通道已关闭",a),b=null})});module.parent||server.listen(agiconf.port),module.exports=server;