/*! SccinAGI 2014-03-18 */
var AGI=require("./lib/index"),nami=require(__dirname+"/asterisk/asmanager").nami,conf=require("node-conf"),logconf=conf.load("log4js"),agiconf=conf.load("fastagi"),moment=require("moment"),routing=require("./smartAgi/src/Routings"),Schemas=require("./database/schema").Schemas,log4js=require("log4js");log4js.configure(logconf,agiconf);var logger=log4js.getLogger("agi");logger.setLevel("DEBUG");var server=AGI.createServer(function(a){logger.debug("当前上下文状态："+a.state+"，上下文流是否可读："+a.stream.readable);var b=require("./database/schema").Schemas,c=new routing({context:a,Schemas:b,agiconf:agiconf,nami:nami,args:null,logger:logger,vars:null});server.getConnections(function(a,b){logger.info("当前服务器连接数："+b)}),a.on("variables",function(a){var b=a.agi_network_script.split("?"),d=b[0],e={};if(b[1]&&""!==b[1]){var f=b[1].split("&");for(var g in f){var h=f[g].split("=");e[h[0]]=h[1]}}c.args=e,c.vars=a,"function"==typeof c[d]?c[d]():c.dodefault(),logger.info("捕获到来自"+a.agi_callerid+"的新呼叫， 呼叫编号为: "+a.agi_uniqueid)}),a.on("response",function(a){logger.info("捕获到监听事件返回的结果：",a)}),a.on("hangup",function(){logger.info("发生挂机事件."),c.args.routerline?(logger.info("正常呼叫中心流程，记录挂机时间."),b.pbxCdr.update({where:{id:c.sessionnum},update:{endtime:moment().format("YYYY-MM-DD HH:mm:ss")}},function(b){b&&logger.error(b),a.end()})):a.end()}),a.on("error",function(b){logger.info("agi error",b),a.end()}),a.on("close",function(a){logger.info("AGI通道已关闭",a),c=null})});module.parent||server.listen(agiconf.port),module.exports=server;