<!DOCTYPE html>
<html>
<head lang="cn">
<meta charset="UTF-8">
<title>欢迎使用北京市评标专家库报表REST API</title>
<link rel="stylesheet" type="text/css" href="public/javascript/jquery-easyui-1.4.1/themes/bootstrap/easyui.css">
<link rel="stylesheet" type="text/css" href="public/javascript/jquery-easyui-1.4.1/themes/icon.css">
<script type="text/javascript" src="public/javascript/jquery-easyui-1.4.1/jquery.min.js"></script>
<script type="text/javascript" src="public/javascript/jquery-easyui-1.4.1/jquery.easyui.min.js"></script>
<script type="text/javascript" src="public/javascript/jquery-easyui-1.4.1/locale/easyui-lang-zh_CN.js"></script>
<script type="text/javascript" src="public/javascript/q.js"></script>
<script type="text/javascript" src="lib/app.js"></script>
<script type="text/javascript" src="lib/jslib/public.js"></script>
<script type="text/javascript" src="public/javascript/highcharts/highcharts.js"></script>
<script type="text/javascript" src="public/javascript/highcharts/modules/exporting.js"></script>
<script type="text/javascript" src="public/javascript/highcharts/export-csv.js"></script>
<script type="text/javascript">
    (function ($) {
        function pagerFilter(data) {
            if ($.isArray(data)) { // is array
                data = {
                    total: data.length,
                    rows: data
                }
            }
            var dg = $(this);
            var state = dg.data('treegrid');
            var opts = dg.treegrid('options');
            var pager = dg.treegrid('getPager');
            pager.pagination({
                onSelectPage: function (pageNum, pageSize) {
                    opts.pageNumber = pageNum;
                    opts.pageSize = pageSize;
                    pager.pagination('refresh', {
                        pageNumber: pageNum,
                        pageSize: pageSize
                    });
                    dg.treegrid('loadData', state.allRows);
                }
            });
            opts.pageNumber = pager.pagination('options').pageNumber || 1;
            if (!state.allRows) {
                state.allRows = data.rows;
            }
            var topRows = [];
            var childRows = [];
            $.map(state.allRows, function (row) {
                row._parentId ? childRows.push(row) : topRows.push(row);
            });
            data.total = topRows.length;
            var start = (opts.pageNumber - 1) * parseInt(opts.pageSize);
            var end = start + parseInt(opts.pageSize);
            data.rows = $.extend(true, [], topRows.slice(start, end).concat(childRows));
            window.console.log(data);
            return data;
        }

        var appendMethod = $.fn.treegrid.methods.append;
        var removeMethod = $.fn.treegrid.methods.remove;
        var loadDataMethod = $.fn.treegrid.methods.loadData;
        $.extend($.fn.treegrid.methods, {
            clientPaging: function (jq) {
                return jq.each(function () {
                    var state = $(this).data('treegrid');
                    var opts = state.options;
                    opts.loadFilter = pagerFilter;
                    var onBeforeLoad = opts.onBeforeLoad;
                    opts.onBeforeLoad = function (row, param) {
                        state.allRows = null;
                        return onBeforeLoad.call(this, row, param);
                    }
                    $(this).treegrid('loadData', state.data);
                    if (opts.url) {
                        $(this).treegrid('reload');
                    }
                });
            },
            loadData: function (jq, data) {
                jq.each(function () {
                    $(this).data('treegrid').allRows = null;
                });
                return loadDataMethod.call($.fn.treegrid.methods, jq, data);
            },
            append: function (jq, param) {
                return jq.each(function () {
                    var state = $(this).data('treegrid');
                    if (state.options.loadFilter == pagerFilter) {
                        $.map(param.data, function (row) {
                            row._parentId = row._parentId || param.parent;
                            state.allRows.push(row);
                        });
                        $(this).treegrid('loadData', state.allRows);
                    } else {
                        appendMethod.call($.fn.treegrid.methods, $(this), param);
                    }
                })
            },
            remove: function (jq, id) {
                return jq.each(function () {
                    if ($(this).treegrid('find', id)) {
                        removeMethod.call($.fn.treegrid.methods, $(this), id);
                    }
                    var state = $(this).data('treegrid');
                    if (state.options.loadFilter == pagerFilter) {
                        for (var i = 0; i < state.allRows.length; i++) {
                            if (state.allRows[i][state.options.idField] == id) {
                                state.allRows.splice(i, 1);
                                break;
                            }
                        }
                        $(this).treegrid('loadData', state.allRows);
                    }
                })
            },
            getAllRows: function (jq) {
                return jq.data('treegrid').allRows;
            }
        });

    })(jQuery);
</script>
<script type="text/javascript">
    //window.Q = require('q');//定义全局的promise
    window.reportApp = {};



    /***
     * @description 服务端分页
     * @param gridId - grid table ID
     * @constructor
     */
    function ServerPagin(gridId, url, conditions) {
        var companyCode = $('#hiddenCompanyCode').val();
        var name = $('#txtName').val();
        if (companyCode == "") companyCode = "000";
        var dg = $('#gridId');
        var opts = dg.datagrid('options');
        var pager = dg.datagrid('getPager');
        var _pageNumber = opts.pageNumber;
        var _pageSize = opts.pageSize;
        if (typeof (conditions) !== 'object') {
            conditions = {};
        }
        conditions.p = _pageNumber;
        conditions.s = _pageSize;
        //异步获取数据到javascript对象，入参为查询条件和页码信息
        $.post(url, conditions, function (data) {
            //注意此处从数据库传来的data数据有记录总行数的total列
            var total = JSON.parse(data).rows[0].total;
            $('#gridId').datagrid('loadData', JSON.parse(data));
            pager.pagination({
                //更新pagination的导航列表各参数
                total: total,//总数
                pageSize: _pageSize,//行数
                pageNumber: _pageNumber//页数
            });
        });

    }

</script>

</head>
<body>
<input style="display:none;" id="fileDialog" type="file" nwdirectory/>

<h2> 欢迎使用北京市评标专家库报表REST API服务！</h2>

<div style="margin:20px 0;"></div>
<div class="easyui-layout" style="width:100%;height:640px;">
    <div id="appMenmu" data-options="region:'west'" title="北京，您好！" style="width:20%;padding:10px;height:620px;">
        <ul id="menmus"></ul>
    </div>
    <div data-options="region:'center'" id="content" title="">
        <div style="margin:20px 0 10px 0;"></div>
    </div>
    <div id="dd" class="easyui-dialog">
    </div>
</div>


<script type="text/javascript">


    // var Server = require('./Server.js');
    // var server = new Server();
    $(function () {

            $("#menmus").tree({
                url: "./views/menmu.json",
                method: 'get',
                animate: true,
                lines: true,
                onClick: function (node) {//单击事件
                    if (node.attributes && node.attributes.url) {
                        $("#content").panel({
                            title: node.text || "",
                            href: "./views/" + node.attributes.url,
                            onLoad: function () {
                                //alert(node.id);
                            }
                        });

                    }
                }
            });

            $("#content").panel({
                href: './views/index.html',
                onLoad: function () {
                    reportApp.server.start(function (err) {

                    });
                }
            });
    });
</script>

</body>

</html>