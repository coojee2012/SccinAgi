<!DOCTYPE html>
<html>
<head lang="cn">
<meta charset="UTF-8">
<title>欢迎使用北京市评标专家库报表REST API</title>
<link rel="stylesheet" type="text/css" href="public/javascript/jquery-easyui-1.4.1/themes/bootstrap/easyui.css">
<link rel="stylesheet" type="text/css" href="public/javascript/jquery-easyui-1.4.1/themes/icon.css">
<script type="text/javascript" src="public/javascript/jquery-easyui-1.4.1/jquery.min.js"></script>
<script type="text/javascript" src="public/javascript/jquery-easyui-1.4.1/jquery.easyui.min.js"></script>
<script type="text/javascript" src="public/javascript/jquery-easyui-1.4.1/locale/easyui-lang-zh_CN.js"></script>

<script type="text/javascript" src="public/javascript/highcharts/highcharts.js"></script>
<script type="text/javascript" src="public/javascript/highcharts/modules/exporting.js"></script>
<script type="text/javascript" src="public/javascript/highcharts/export-csv.js"></script>
<script type="text/javascript">
    (function ($) {
        function pagerFilter(data) {
            if ($.isArray(data)) { // is array
                data = {
                    total: data.length,
                    rows: data
                }
            }
            var dg = $(this);
            var state = dg.data('treegrid');
            var opts = dg.treegrid('options');
            var pager = dg.treegrid('getPager');
            pager.pagination({
                onSelectPage: function (pageNum, pageSize) {
                    opts.pageNumber = pageNum;
                    opts.pageSize = pageSize;
                    pager.pagination('refresh', {
                        pageNumber: pageNum,
                        pageSize: pageSize
                    });
                    dg.treegrid('loadData', state.allRows);
                }
            });
            opts.pageNumber = pager.pagination('options').pageNumber || 1;
            if (!state.allRows) {
                state.allRows = data.rows;
            }
            var topRows = [];
            var childRows = [];
            $.map(state.allRows, function (row) {
                row._parentId ? childRows.push(row) : topRows.push(row);
            });
            data.total = topRows.length;
            var start = (opts.pageNumber - 1) * parseInt(opts.pageSize);
            var end = start + parseInt(opts.pageSize);
            data.rows = $.extend(true, [], topRows.slice(start, end).concat(childRows));
            window.console.log(data);
            return data;
        }

        var appendMethod = $.fn.treegrid.methods.append;
        var removeMethod = $.fn.treegrid.methods.remove;
        var loadDataMethod = $.fn.treegrid.methods.loadData;
        $.extend($.fn.treegrid.methods, {
            clientPaging: function (jq) {
                return jq.each(function () {
                    var state = $(this).data('treegrid');
                    var opts = state.options;
                    opts.loadFilter = pagerFilter;
                    var onBeforeLoad = opts.onBeforeLoad;
                    opts.onBeforeLoad = function (row, param) {
                        state.allRows = null;
                        return onBeforeLoad.call(this, row, param);
                    }
                    $(this).treegrid('loadData', state.data);
                    if (opts.url) {
                        $(this).treegrid('reload');
                    }
                });
            },
            loadData: function (jq, data) {
                jq.each(function () {
                    $(this).data('treegrid').allRows = null;
                });
                return loadDataMethod.call($.fn.treegrid.methods, jq, data);
            },
            append: function (jq, param) {
                return jq.each(function () {
                    var state = $(this).data('treegrid');
                    if (state.options.loadFilter == pagerFilter) {
                        $.map(param.data, function (row) {
                            row._parentId = row._parentId || param.parent;
                            state.allRows.push(row);
                        });
                        $(this).treegrid('loadData', state.allRows);
                    } else {
                        appendMethod.call($.fn.treegrid.methods, $(this), param);
                    }
                })
            },
            remove: function (jq, id) {
                return jq.each(function () {
                    if ($(this).treegrid('find', id)) {
                        removeMethod.call($.fn.treegrid.methods, $(this), id);
                    }
                    var state = $(this).data('treegrid');
                    if (state.options.loadFilter == pagerFilter) {
                        for (var i = 0; i < state.allRows.length; i++) {
                            if (state.allRows[i][state.options.idField] == id) {
                                state.allRows.splice(i, 1);
                                break;
                            }
                        }
                        $(this).treegrid('loadData', state.allRows);
                    }
                })
            },
            getAllRows: function (jq) {
                return jq.data('treegrid').allRows;
            }
        });

    })(jQuery);
</script>
<script type="text/javascript">
    window.Q = require('q');//定义全局的promise
    window.reportApp = {};
    reportApp.gui = require('nw.gui');
    reportApp.format = require('date-format');
    reportApp.os = require('os');
    reportApp.win = reportApp.gui.Window.get();
    reportApp.app = reportApp.gui.App;

    reportApp.appDir = "";//localStorage.getItem('appdir');
    reportApp.Server = require('./Server.js');
    reportApp.isAppStart = false;


    function CheckConifgDir() {
        var deferred = Q.defer();
        var osType = reportApp.os.type().toLowerCase();
        var cmd = "";
        var baseDir="";
        if (/windows/.test(osType)) {
            cmd = 'echo %username%';
        } else if (/linux/.test(osType)) {
            cmd = 'whoami';
        } else {
            deferred.reject('系统平台不受支持');
        }
        var exec = require('child_process').exec;
        exec(cmd, function (error, stdout, stderr) {
            if (error) {
                deferred.reject(error);
            } else if (stderr) {

                deferred.reject(stderr);
            } else {

                if (/windows/.test(osType)) {
                    baseDir="C:/Users/"+stdout.replace(/\s*|\r|\r\n/g,"")+"/AppData/Local/ReportAPIConfig";
                    //baseDir="C:/Users/LinYong/AppData/Local/datattt";
                }else{
                    baseDir="/home/"+stdout.replace(/\s*|\r|\r\n/g,"")+"/ReportAPIConfig";
                }
                var fs = require('fs');
                fs.exists(baseDir,function(exists){

                   if(!exists){
                       var mkdirp = require('mkdirp');

                       fs.mkdir(baseDir, function (err) {

                           if(err){
                               alert(err);
                               deferred.reject(err);
                           }else{
                               alert(baseDir);
                               reportApp.appDir=baseDir;
                               deferred.resolve(reportApp.appDir);
                           }
                       });
                   } else{
                       reportApp.appDir=baseDir;
                       deferred.resolve(reportApp.appDir);
                   }
                });

            }
        });

        return deferred.promise;
    }

    /***
     * @descript 初始化应用程序
     */
    function initApp() {
        var fs = require('fs');
    }
    /***
     * @description 读取配置文件
     */
    function readConfig() {
        var deferred = Q.defer();
        var fs = require('fs');
        var filename = reportApp.appDir + "/setting.json";
        fs.exists(filename, function (exists) {
            if (exists) {
                fs.readFile(filename, function (err, data) {
                    if (err) {
                        alert("读取配置文件发生异常：" + err);
                        deferred.reject(err);
                    } else {
                        reportApp.config = JSON.parse(data);
                        deferred.resolve(reportApp.config);
                    }
                });
            } else {
                alert("配置文件：" + filename + "不存在！");
                deferred.reject('unconfiged');
            }
        });
        return deferred.promise;
    }

    function loadLog() {
        var fs = require('fs');
        var filename = reportApp.appDir + "/restApi.log-" + reportApp.format('yyyy-MM-dd', new Date()) + ".log";
        fs.readFile(filename, {encoding: 'utf8'}, function (err, data) {
            if (err) {
                $("#log").prepend(err);
            } else {
                data = data.replace(/\r|\r\n/g, '</br>');
                $("#log").prepend(data);
            }

        });
    }
    /***
     * @description 服务端分页
     * @param gridId - grid table ID
     * @constructor
     */
    function ServerPagin(gridId, url, conditions) {
        var companyCode = $('#hiddenCompanyCode').val();
        var name = $('#txtName').val();
        if (companyCode == "") companyCode = "000";
        var dg = $('#gridId');
        var opts = dg.datagrid('options');
        var pager = dg.datagrid('getPager');
        var _pageNumber = opts.pageNumber;
        var _pageSize = opts.pageSize;
        if (typeof (conditions) !== 'object') {
            conditions = {};
        }
        conditions.p = _pageNumber;
        conditions.s = _pageSize;
        //异步获取数据到javascript对象，入参为查询条件和页码信息
        $.post(url, conditions, function (data) {
            //注意此处从数据库传来的data数据有记录总行数的total列
            var total = JSON.parse(data).rows[0].total;
            $('#gridId').datagrid('loadData', JSON.parse(data));
            pager.pagination({
                //更新pagination的导航列表各参数
                total: total,//总数
                pageSize: _pageSize,//行数
                pageNumber: _pageNumber//页数
            });
        });

    }

</script>

</head>
<body>
<input style="display:none;" id="fileDialog" type="file" nwdirectory/>

<h2> 欢迎使用北京市评标专家库报表REST API服务！</h2>

<div style="margin:20px 0;"></div>
<div class="easyui-layout" style="width:100%;height:640px;">
    <div id="appMenmu" data-options="region:'west'" title="北京，您好！" style="width:20%;padding:10px;height:620px;">
        <ul id="menmus"></ul>
    </div>
    <div data-options="region:'center'" id="content" title="">
        <div style="margin:20px 0 10px 0;"></div>
    </div>
    <div id="dd" class="easyui-dialog">
    </div>
</div>


<script type="text/javascript">

    // Listen to the minimize event
    reportApp.win.on('minimize', function () {
        ///alert('Window is minimized');
    });
    // var Server = require('./Server.js');
    // var server = new Server();
    $(function () {
        $('#dd').dialog('close');
        CheckConifgDir().then(function (dir) {
            $("#menmus").tree({
                url: "./view/menmu.json",
                method: 'get',
                animate: true,
                lines: true,
                onClick: function (node) {//单击事件
                    if (node.attributes && node.attributes.url) {
                        $("#content").panel({
                            title: node.text || "",
                            href: "./view/" + node.attributes.url,
                            onLoad: function () {
                                //alert(node.id);
                            }
                        });

                    }
                }
            });
        }).then(function () {
            return  readConfig();
        }).then(function (config) {
            reportApp.server = new reportApp.Server(config);
        }).then(function () {
            $("#content").panel({
                href: './view/index.html',
                onLoad: function () {
                    reportApp.server.start(function () {
                        reportApp.isAppStart = true;
                        $("#btnText").html("结束");
                        $.messager.show({
                            title: '友情提示',
                            msg: 'REST API启动成功.',
                            showType: 'show'
                        });
                    });
                }
            });
        }).catch(function (err) {
            if (err === 'unconfiged') {
                alert("应用程序未能加载配置文件，请先设置相关配置！");
                $("#content").panel({
                    title: '服务配置',
                    href: './view/config.html',
                    onLoad: function () {
                    }
                });
            }
        });
    });
</script>

</body>

</html>